---
phase: 15-strategic-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/02-strategic-architecture/index.md
autonomous: true

must_haves:
  truths:
    - "Chapter 2 TL;DR mentions MCP server, three tools, and generate-validate-fix loop — skimmable in 30 seconds"
    - "MCP is framed as concrete realization of the existing two-layer architecture, not a replacement"
    - "MCP topology diagram renders correctly showing Host/Client/Server/backends hierarchy"
    - "Three tool definitions (search_bbj_knowledge, generate_bbj_code, validate_bbj_syntax) have complete JSON schemas a developer could implement against"
    - "Decision callout 'MCP as the Unified Integration Protocol' has all four fields (Choice, Rationale, Alternatives considered, Status) and frames MCP as evolution"
    - "webforJ MCP server is referenced as organizational precedent in one brief callout"
  artifacts:
    - path: "docs/02-strategic-architecture/index.md"
      provides: "Updated Chapter 2 with TL;DR, MCP topology diagram, tool schemas, decision callout"
      contains: "search_bbj_knowledge"
  key_links:
    - from: "docs/02-strategic-architecture/index.md"
      to: "existing chapter structure"
      via: "New MCP section inserted after 'The Shared Foundation' section"
      pattern: "## The MCP Server"
---

<objective>
Update Chapter 2's opening (TL;DR, intro paragraph), architecture overview diagram, and add the core MCP Server section with three tool schemas, webforJ precedent, and the MCP decision callout.

Purpose: Establish the MCP vocabulary and concrete tool definitions that all subsequent phases (16-19) will reference. This is the "heavy lift" of new content — the MCP Server section with schemas and decision callout.

Output: Chapter 2 updated through the new "The MCP Server: Concrete Integration Layer" section. The file is left in a valid state (all existing sections preserved, new section inserted, but Integration Patterns / Deployment / Status updates handled in Plan 02).
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/15-strategic-architecture/15-CONTEXT.md
@.planning/phases/15-strategic-architecture/15-RESEARCH.md
@docs/02-strategic-architecture/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TL;DR, opening paragraph, and architecture overview diagram</name>
  <files>docs/02-strategic-architecture/index.md</files>
  <action>
Update three sections at the top of Chapter 2. The rest of the file stays untouched in this task.

**1. TL;DR block (lines 9-14):**
Rewrite the `:::tip[TL;DR]` block to mention:
- Unified infrastructure (preserve this framing from the original)
- MCP server as the concrete integration layer
- Three tools: search_bbj_knowledge, generate_bbj_code, validate_bbj_syntax
- Generate-validate-fix loop using the BBj compiler
- Keep it 3-5 sentences, skimmable in 30 seconds

Match the exact `:::tip[TL;DR]` format. No blank line before `:::`. See research Pattern 1.

**2. Opening paragraph (lines 16-19):**
Add one sentence to the existing opening paragraph noting that MCP makes the architecture concrete. The existing sentence "how should that model -- and the infrastructure around it -- be organized?" stays. Add after the current text something like: "This chapter also defines the MCP server that makes this architecture concrete — three tools that any AI-powered client can consume."

Keep the link to Ch1. Keep the professional peer voice. Do NOT rewrite the whole paragraph — extend it.

**3. Architecture Overview diagram (lines 50-71):**
Replace the existing `graph TB` diagram with the MCP topology diagram from the research. This diagram shows:
- Subgraph "MCP Clients (Application Layer)" with IDE, Chat, Future nodes
- Subgraph "BBj MCP Server" with search_bbj_knowledge, generate_bbj_code, validate_bbj_syntax nodes
- Subgraph "Backend Services (Shared Foundation)" with RAG, Model, Compiler nodes
- Arrows: Clients → Server tools → Backend services
- Style: Green fill for backend nodes (#e8f4e8,stroke:#2d8a2d), match existing color palette
- HTML node labels with `<b>`, `<br/>` format matching existing diagrams

Use the exact diagram from 15-RESEARCH.md "Example 1: Updated Architecture Diagram" as the starting point.

Update the explanatory text after the diagram (lines 73-76) to reflect MCP mediation:
- Applications connect through the MCP server (not directly to model/RAG)
- The MCP server exposes three tools that abstract the backend complexity
- Any MCP-compatible host can consume these tools without custom integration code

**Anti-patterns to avoid:**
- Do NOT delete the existing "How They Work Together" sequence diagram (lines 120-132) — it stays
- Do NOT change the "Case Against Point Solutions" section or the existing "Unified Infrastructure" decision callout
- Technology references must match published chapters: Qwen2.5-Coder-7B (not CodeLlama), pgvector (not Qdrant), Ollama
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-ai-strategy && npx docusaurus build 2>&1 | tail -20` — build must complete without errors. Manually verify:
1. TL;DR contains "MCP server", "search_bbj_knowledge", "generate_bbj_code", "validate_bbj_syntax", and "generate-validate-fix"
2. Architecture diagram has three subgraphs (Clients, Server, Backends)
3. Existing "How They Work Together" sequence diagram is still present
4. No mentions of CodeLlama, Qdrant, or StarCoder2
  </verify>
  <done>TL;DR mentions MCP + three tools + generate-validate-fix. Architecture overview diagram shows MCP topology. Explanatory text describes MCP mediation. All existing sections below the architecture overview are untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Add "The MCP Server: Concrete Integration Layer" section with tool schemas and decision callout</name>
  <files>docs/02-strategic-architecture/index.md</files>
  <action>
Insert a new major section after "### How They Work Together" (after line 139) and BEFORE "## Three Initiatives" (line 141). This is the core new content for Phase 15.

**Section structure:**

```
## The MCP Server: Concrete Integration Layer
```

**2a. MCP introduction paragraph (1 paragraph, ~4-6 sentences):**
- Introduce MCP (Model Context Protocol) as a standard protocol for connecting AI applications to external tools
- One sentence explaining what MCP provides (standard tool discovery, schema-based invocation, any-client compatibility)
- Frame it as the concrete interface boundary that realizes the "standard APIs" promised earlier in the chapter
- Link to the official MCP spec: https://modelcontextprotocol.io/
- Do NOT explain JSON-RPC, transport internals, or capability negotiation — one paragraph, then move to BBj specifics
- Follow the QLoRA pattern from Ch3: brief concept, then immediately into BBj application

**2b. Three tool definitions with JSON schemas:**
Present all three tools in sequence. For each tool:
- Tool name as a `###` heading (e.g., `### search_bbj_knowledge`)
- 2-3 sentences explaining what the tool does and which backend it connects to
- Compact JSON schema in a fenced `json` code block

Use EXACTLY these tool names (locked decision from CONTEXT.md):
1. `search_bbj_knowledge` — searches the RAG database (pgvector) with generation-aware filtering. Returns ranked documentation and code examples with source citations.
2. `generate_bbj_code` — sends enriched prompts to the fine-tuned model (Qwen2.5-Coder via Ollama). Includes RAG context, generation target, and optional existing code for completion.
3. `validate_bbj_syntax` — runs generated code through the BBj compiler (bbjcpl -N) for ground-truth syntax validation. Returns pass/fail with compiler error messages.

For schemas, use the compact JSON Schema format from 15-RESEARCH.md "Example 3". Key fields for each:

**search_bbj_knowledge:**
```json
{
  "name": "search_bbj_knowledge",
  "description": "Search BBj documentation and code examples with generation-aware filtering. Returns ranked results from the RAG pipeline with source citations.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": { "type": "string", "description": "Natural language search query" },
      "generation": { "type": "string", "enum": ["all", "character", "vpro5", "bbj-gui", "dwc"], "description": "Filter results by BBj generation. Omit for cross-generation search." },
      "limit": { "type": "integer", "default": 5, "description": "Maximum number of results to return" }
    },
    "required": ["query"]
  }
}
```

**generate_bbj_code:**
```json
{
  "name": "generate_bbj_code",
  "description": "Generate BBj code using the fine-tuned model with RAG-enriched context. Produces generation-appropriate syntax based on the target BBj generation.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "prompt": { "type": "string", "description": "Natural language description of the code to generate" },
      "generation": { "type": "string", "enum": ["character", "vpro5", "bbj-gui", "dwc"], "description": "Target BBj generation for the generated code" },
      "context": { "type": "string", "description": "Surrounding code or additional context for more accurate generation" },
      "max_tokens": { "type": "integer", "default": 512, "description": "Maximum tokens in the generated response" }
    },
    "required": ["prompt", "generation"]
  }
}
```

**validate_bbj_syntax:**
```json
{
  "name": "validate_bbj_syntax",
  "description": "Validate BBj code syntax using the BBj compiler (bbjcpl). Returns ground-truth validation results — not heuristic, not LLM-based.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "code": { "type": "string", "description": "BBj source code to validate" },
      "classpath": { "type": "string", "description": "Optional classpath for resolving external dependencies" }
    },
    "required": ["code"]
  }
}
```

**2c. webforJ MCP precedent (1 paragraph or brief callout — ARCH-07):**
After the three tool definitions, add a brief paragraph noting:
- BASIS already ships a webforJ MCP server (at mcp.webforj.com), establishing the organizational pattern
- webforJ needs only knowledge search (Java is well-understood by LLMs)
- BBj MCP server follows the same approach but adds code generation and compiler validation — because LLMs do NOT understand BBj
- This is extending a proven organizational approach, not an experiment
Keep it to ONE paragraph. The requirement says "one callout, not belabored."

**2d. Decision callout — ARCH-09:**
Add the decision callout using EXACTLY the established format (4 fields):

```markdown
:::info[Decision: MCP as the Unified Integration Protocol]
**Choice:** [one sentence — expose all BBj AI capabilities through a single MCP server]

**Rationale:** [why MCP fits — standard protocol, any-client compatibility, webforJ precedent, same lineage as LSP which Langium uses]

**Alternatives considered:** [REST API (requires custom client code), custom VS Code extension API (locks to one editor), language-specific plugin system (fragments ecosystem)] — give fair treatment then explain why MCP wins for BBj

**Status:** [Architecture defined. Three tool schemas specified. Generate-validate-fix loop validated by bbjcpltool proof-of-concept. MCP server implementation planned.]
:::
```

Use the example from 15-RESEARCH.md "Example 4" as a starting point. Frame as evolution of unified architecture, not replacement.

**Anti-patterns to avoid:**
- Do NOT explain JSON-RPC protocol
- Do NOT show TypeScript server implementation code
- Do NOT mention Resources, Prompts, Sampling, or multi-agent patterns
- Do NOT speculate about bbjcpltool implementation details (no file paths, no hook scripts)
- All backend technology references: Qwen2.5-Coder-7B via Ollama, pgvector, bbjcpl
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-ai-strategy && npx docusaurus build 2>&1 | tail -20` — build succeeds.
Grep checks:
1. `grep -c "search_bbj_knowledge" docs/02-strategic-architecture/index.md` — appears at least 3 times (heading + schema + text)
2. `grep -c "generate_bbj_code" docs/02-strategic-architecture/index.md` — appears at least 3 times
3. `grep -c "validate_bbj_syntax" docs/02-strategic-architecture/index.md` — appears at least 3 times
4. `grep "Decision: MCP as the Unified Integration Protocol" docs/02-strategic-architecture/index.md` — found
5. `grep -i "webforJ" docs/02-strategic-architecture/index.md` — found (precedent reference)
6. `grep ":::info\[Decision:" docs/02-strategic-architecture/index.md` — appears exactly 2 times (original + new)
7. No mentions of CodeLlama, Qdrant, StarCoder2, JSON-RPC in new content
  </verify>
  <done>New "The MCP Server: Concrete Integration Layer" section exists after "How They Work Together" and before "Three Initiatives". Contains: MCP intro paragraph, three tool schemas in JSON format, webforJ precedent paragraph, and "MCP as the Unified Integration Protocol" decision callout with all four fields. The chapter reads as one cohesive narrative — MCP extends the unified architecture story naturally.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx docusaurus build` succeeds with zero errors
2. Chapter 2 TL;DR mentions MCP server, three tools, and generate-validate-fix (ARCH-01)
3. MCP framed as evolution of existing architecture (ARCH-02)
4. MCP topology diagram renders with three subgraphs (ARCH-03)
5. Three tool definitions have complete JSON schemas (ARCH-04)
6. webforJ MCP precedent referenced once (ARCH-07)
7. Decision callout has all four fields and frames MCP as evolution (ARCH-09)
8. Existing chapter sections (Case Against Point Solutions, Unified Infrastructure decision, Shared Foundation, How They Work Together) are preserved
9. No technology contradictions (Qwen2.5-Coder-7B, pgvector, Ollama, bbjcpl only)
</verification>

<success_criteria>
- ARCH-01 satisfied: TL;DR updated
- ARCH-02 satisfied: MCP as concrete realization framing
- ARCH-03 satisfied: MCP topology diagram
- ARCH-04 satisfied: Three tool schemas
- ARCH-07 satisfied: webforJ precedent
- ARCH-09 satisfied: Decision callout
- Chapter narrative flows cohesively from existing content into MCP section
- Docusaurus build passes
</success_criteria>

<output>
After completion, create `.planning/phases/15-strategic-architecture/15-01-SUMMARY.md`
</output>
