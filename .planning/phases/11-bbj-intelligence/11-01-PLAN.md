---
phase: 11-bbj-intelligence
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/src/bbj_rag/models.py
  - rag-ingestion/src/bbj_rag/intelligence/__init__.py
  - rag-ingestion/src/bbj_rag/intelligence/generations.py
  - rag-ingestion/src/bbj_rag/intelligence/report.py
  - rag-ingestion/tests/test_generations.py
  - rag-ingestion/sql/schema.sql
autonomous: true

must_haves:
  truths:
    - "Generation tagger assigns specific labels (all, character, vpro5, bbj_gui, dwc) based on file path, condition tags, and content patterns -- not everything defaults to bbj"
    - "Documents with ambiguous signals are flagged as untagged rather than silently defaulting"
    - "Deprecated/superseded content is detected from condition tags and flagged with a boolean field"
    - "Running the tagger on actual Flare paths produces a plausible distribution where <50% is tagged 'all'"
    - "Summary report prints generation counts, untagged count, and deprecated/superseded counts"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/intelligence/generations.py"
      provides: "Generation StrEnum, Signal dataclass, signal extractors, resolve_signals(), tag_generation()"
      contains: "class Generation(StrEnum)"
    - path: "rag-ingestion/src/bbj_rag/intelligence/report.py"
      provides: "Summary report printer for generation/type distribution"
      contains: "def print_report"
    - path: "rag-ingestion/src/bbj_rag/intelligence/__init__.py"
      provides: "Public API re-exports for intelligence package"
      contains: "tag_generation"
    - path: "rag-ingestion/src/bbj_rag/models.py"
      provides: "Document and Chunk models with context_header and deprecated fields"
      contains: "context_header"
    - path: "rag-ingestion/sql/schema.sql"
      provides: "Updated DDL with context_header and deprecated columns"
      contains: "context_header"
    - path: "rag-ingestion/tests/test_generations.py"
      provides: "Tests for generation tagger"
      min_lines: 80
  key_links:
    - from: "rag-ingestion/src/bbj_rag/intelligence/generations.py"
      to: "rag-ingestion/src/bbj_rag/models.py"
      via: "Generation StrEnum values used as generations list entries"
      pattern: "Generation\\."
    - from: "rag-ingestion/src/bbj_rag/intelligence/generations.py"
      to: "rag-ingestion/src/bbj_rag/parsers/flare_cond.py"
      via: "Condition tag strings consumed as signal source"
      pattern: "Primary\\."
---

<objective>
Implement the multi-signal generation tagger that classifies BBj documentation by product generation (character, vpro5, bbj_gui, dwc, all) using condition tags, file paths, and content patterns.

Purpose: This replaces the Phase 10 default of `["bbj"]` for all documents with granular generation labels, enabling generation-filtered retrieval in the RAG pipeline (e.g., "show only DWC content").

Output: `intelligence/` package with Generation StrEnum, signal-based tagger, summary report; updated Document/Chunk models with `context_header` and `deprecated` fields; updated SQL DDL.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-bbj-intelligence/11-RESEARCH.md
@rag-ingestion/src/bbj_rag/models.py
@rag-ingestion/src/bbj_rag/parsers/flare_cond.py
@rag-ingestion/src/bbj_rag/parsers/flare_toc.py
@rag-ingestion/src/bbj_rag/parsers/__init__.py
@rag-ingestion/sql/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intelligence package, Generation StrEnum, model updates, and DDL changes</name>
  <files>
    rag-ingestion/src/bbj_rag/intelligence/__init__.py
    rag-ingestion/src/bbj_rag/intelligence/generations.py
    rag-ingestion/src/bbj_rag/intelligence/report.py
    rag-ingestion/src/bbj_rag/models.py
    rag-ingestion/sql/schema.sql
  </files>
  <action>
**1. Create `intelligence/__init__.py`** with public API re-exports. For now, export `Generation` and `tag_generation` from `generations.py`, and `print_report` from `report.py`. This is a placeholder that will grow in Plan 11-02.

**2. Create `intelligence/generations.py`** with:

a) **Generation StrEnum** with 5 members using `auto()`:
   - `ALL` -> `"all"` (cross-generation)
   - `CHARACTER` -> `"character"` (green-screen/terminal)
   - `VPRO5` -> `"vpro5"` (Visual PRO/5)
   - `BBJ_GUI` -> `"bbj_gui"` (BBj GUI/Swing)
   - `DWC` -> `"dwc"` (Dynamic Web Client)

b) **Signal frozen dataclass** (slots=True): `generation: Generation`, `weight: float`, `source: str`

c) **Path signal extractor** `signal_from_path(content_relative_path: str) -> list[Signal]`:
   - Use `_PATH_GENERATION_MAP: dict[str, set[Generation]]` matching file path prefixes.
   - Sort keys by length descending so more specific paths match first (e.g., `commands/bbj-commands/` before `commands/`).
   - Weight: 0.6. Source: `"file_path"`.
   - Path map (from 11-RESEARCH.md Appendix):
     - bbj_gui: `bbjobjects/`, `bbjevents/`, `bbjinterfaces/`, `gridmethods/`, `gridctrl/`, `bui/`, `appbuildingblocks/`, `mnemonic/sysgui/`
     - dwc: `dwc/`
     - character: `mnemonic/terminal/`
     - vpro5: `guibuild/`, `formbuilder/`, `resbuild/`, `rescomp/`, `resprops/`, `ddbuild/`
     - all: `commands/`, `events/`, `sendmsg/`, `sysadmin/`, `config/`, `usr/`, `dataserv/`, `b3odbc/`, `bbutil/`, `util/`, `eus/`
     - Overrides: `commands/bbj-commands/` -> bbj_gui, `commands/bbj-variables/` -> bbj_gui

d) **Condition tag signal extractor** `signal_from_conditions(conditions: list[str]) -> list[Signal]`:
   - `Primary.Deprecated` and `Primary.Superseded` are NOT generation signals -- they are lifecycle flags handled separately.
   - `Primary.BASISHelp` is informational (means "included in BASISHelp build") but not a discriminating generation signal -- do NOT emit a generation signal for it.
   - `Primary.guibuild_chm` -> vpro5 (weight 0.5)
   - `Primary.resbuild_chm` -> vpro5 (weight 0.5)
   - `Primary.ddbuild_chm` -> vpro5 (weight 0.5)
   - `Primary.config_chm` -> all (weight 0.3)
   - `Primary.EMHelp` -> all (weight 0.3)
   - `Primary.BDTHelp` -> all (weight 0.3)
   - Source: `"condition_tag"`.

e) **Content pattern signal extractor** `signal_from_content(content: str) -> list[Signal]`:
   - Compile regex patterns once at module level in `_CONTENT_GENERATION_PATTERNS: dict[Generation, list[re.Pattern[str]]]`.
   - bbj_gui patterns: `PROCESS_EVENTS` (case-insensitive), `BBjAPI\(\)`, `BBjSysGui`, `SysGUI` (case-insensitive)
   - dwc patterns: `Dynamic Web Client`, `\bDWC\b`, `BBjWebComponent`, `web\s*component` (case-insensitive)
   - character patterns: `character\s*mode` (case-insensitive), `green.screen` (case-insensitive), `terminal\s*emulat` (case-insensitive)
   - vpro5 patterns: `Visual\s*PRO/5` (case-insensitive), `\bVPRO/?5\b` (case-insensitive), `GUI\s*Builder` (case-insensitive), `Resource\s*Compiler` (case-insensitive)
   - Weight: 0.4 per match. Source: `"content_pattern"`.
   - Only emit one signal per generation per call (even if multiple patterns match for same generation).

f) **Signal resolver** `resolve_signals(signals: list[Signal]) -> list[str]`:
   - Aggregate weights per generation.
   - Threshold: 0.3.
   - Return sorted list of generation string values exceeding threshold.
   - If no signals exceed threshold: return `["untagged"]` (sentinel value, per Research recommendation).
   - IMPORTANT: Return `list[str]` not `list[Generation]` -- downstream models use `list[str]`.

g) **Main tagger function** `tag_generation(content_relative_path: str, conditions: list[str], content: str) -> tuple[list[str], bool]`:
   - Calls all three signal extractors, combines signals, resolves.
   - Second return value is `deprecated: bool` -- True if `Primary.Deprecated` or `Primary.Superseded` in conditions.
   - This is the public API that intelligence __init__.py exports.

**3. Create `intelligence/report.py`** with:
   - `print_report(documents: list[Document]) -> None` that prints a formatted summary:
     - Total documents processed
     - Generation distribution: count and percentage for each Generation value + "untagged"
     - Deprecated count, Superseded count (from metadata["conditions"])
   - Also export `build_report(documents: list[Document]) -> dict[str, Any]` that returns structured data (useful for testing).

**4. Modify `models.py`**:
   - Add `context_header: str = ""` field to both Document and Chunk (empty string default, not required).
   - Add `deprecated: bool = False` field to both Document and Chunk.
   - Add `context_header` parameter to `Chunk.from_content()` factory with default `""`.
   - Add `deprecated` parameter to `Chunk.from_content()` factory with default `False`.
   - Keep existing validators unchanged. The `generations_must_not_be_empty` validator stays -- `["untagged"]` satisfies it.

**5. Modify `sql/schema.sql`**:
   - Add `context_header TEXT NOT NULL DEFAULT ''` column after `content_hash`.
   - Add `deprecated BOOLEAN NOT NULL DEFAULT false` column after `generations`.
   - Update `search_vector` generated column to include context_header: `to_tsvector('english', coalesce(context_header, '') || ' ' || coalesce(title, '') || ' ' || coalesce(content, ''))`.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run python -c "from bbj_rag.intelligence import Generation, tag_generation; print(Generation.BBJ_GUI); print(tag_generation('bbjobjects/Window/bbjwindow.htm', ['Primary.BASISHelp'], 'BBjAPI() demo'))"` -- should print `bbj_gui` and a tuple with `['bbj_gui']` and `False`.

Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run python -c "from bbj_rag.models import Document; d = Document(source_url='x', title='t', doc_type='flare', content='c', generations=['all'], context_header='A > B', deprecated=True); print(d.context_header, d.deprecated)"` -- should print `A > B True`.

Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run ruff check src/bbj_rag/intelligence/` -- no errors.
  </verify>
  <done>
Intelligence package exists with Generation StrEnum (5 members), Signal dataclass, three signal extractors (path/condition/content), signal resolver, tag_generation() public function, and report module. Document/Chunk models have context_header and deprecated fields. SQL DDL updated with new columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive tests for generation tagger</name>
  <files>
    rag-ingestion/tests/test_generations.py
  </files>
  <action>
Create `tests/test_generations.py` with pytest tests covering:

**Signal extractors:**
1. `test_signal_from_path_bbjobjects` -- path starting with `bbjobjects/` yields bbj_gui signal
2. `test_signal_from_path_dwc` -- path starting with `dwc/` yields dwc signal
3. `test_signal_from_path_commands_bbj_override` -- `commands/bbj-commands/foo.htm` yields bbj_gui (not all) -- tests specificity override
4. `test_signal_from_path_commands_general` -- `commands/let.htm` yields all
5. `test_signal_from_path_unknown` -- path not matching any prefix yields empty list
6. `test_signal_from_path_vpro5_guibuild` -- `guibuild/foo.htm` yields vpro5
7. `test_signal_from_path_character_terminal` -- `mnemonic/terminal/foo.htm` yields character

**Condition signals:**
8. `test_signal_from_conditions_guibuild_chm` -- `Primary.guibuild_chm` yields vpro5
9. `test_signal_from_conditions_basis_help_no_signal` -- `Primary.BASISHelp` alone yields empty list (not a discriminating signal)
10. `test_signal_from_conditions_empty` -- empty list yields empty signals

**Content signals:**
11. `test_signal_from_content_bbj_gui_pattern` -- content with "BBjAPI()" yields bbj_gui
12. `test_signal_from_content_dwc_pattern` -- content with "Dynamic Web Client" yields dwc
13. `test_signal_from_content_no_match` -- plain text yields empty list
14. `test_signal_from_content_multiple_same_gen` -- multiple bbj_gui patterns only yield one bbj_gui signal

**Signal resolution:**
15. `test_resolve_signals_single` -- one signal above threshold returns its generation
16. `test_resolve_signals_multiple` -- signals for two different generations returns both sorted
17. `test_resolve_signals_below_threshold` -- signal with weight 0.1 (below 0.3) returns `["untagged"]`
18. `test_resolve_signals_empty` -- no signals returns `["untagged"]`
19. `test_resolve_signals_aggregation` -- two signals for same generation aggregate weights

**Integration (tag_generation):**
20. `test_tag_generation_bbjobjects_path` -- bbj objects path + BASISHelp condition + BBjAPI content -> `["bbj_gui"]`, deprecated=False
21. `test_tag_generation_deprecated` -- any path + `Primary.Deprecated` condition -> deprecated=True
22. `test_tag_generation_superseded` -- any path + `Primary.Superseded` condition -> deprecated=True
23. `test_tag_generation_unknown_path_no_content` -- unrecognized path, no conditions, no pattern content -> `["untagged"]`
24. `test_tag_generation_dwc_content_only` -- unrecognized path but content mentions "DWC" -> `["dwc"]`

**Model updates:**
25. `test_document_context_header_default` -- Document without context_header has empty string default
26. `test_document_deprecated_default` -- Document without deprecated has False default
27. `test_chunk_from_content_with_context_header` -- Chunk.from_content() accepts context_header param

**Report:**
28. `test_build_report_counts` -- build_report with known documents returns correct generation counts

Run all tests: `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run pytest tests/test_generations.py -v`
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run pytest tests/test_generations.py -v` -- all tests pass.

Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run pytest tests/ -v` -- entire test suite passes (no regressions in existing tests from model changes).

Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run ruff check tests/test_generations.py` -- no lint errors.
  </verify>
  <done>
28+ tests covering signal extractors (path, condition, content), signal resolution, tag_generation integration, model field updates, and report output. Full test suite passes including existing tests (no regressions from model changes).
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from bbj_rag.intelligence.generations import Generation; print(list(Generation))"` prints all 5 generation values
2. `uv run pytest tests/test_generations.py -v` -- all 28+ tests pass
3. `uv run pytest tests/ -v` -- full suite passes (no regressions)
4. `uv run ruff check src/bbj_rag/intelligence/` -- clean
5. Generation tagger produces different labels for different paths: bbjobjects->bbj_gui, dwc/->dwc, guibuild/->vpro5, commands/->all, mnemonic/terminal/->character
6. Unknown paths with no content signals produce `["untagged"]`
7. Document and Chunk models accept context_header and deprecated fields
</verification>

<success_criteria>
- Intelligence package exists at `src/bbj_rag/intelligence/` with generations.py, report.py, __init__.py
- Generation StrEnum has exactly 5 members: all, character, vpro5, bbj_gui, dwc
- tag_generation() takes (path, conditions, content) and returns (generations_list, deprecated_bool)
- Signal-based scoring with path (0.6), condition (0.5/0.3), and content (0.4) weights
- resolve_signals returns `["untagged"]` for empty/below-threshold, not `["all"]` or `["bbj"]`
- Document and Chunk have context_header (str, default "") and deprecated (bool, default False)
- SQL DDL has context_header and deprecated columns, search_vector includes context_header
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-bbj-intelligence/11-01-SUMMARY.md`
</output>
