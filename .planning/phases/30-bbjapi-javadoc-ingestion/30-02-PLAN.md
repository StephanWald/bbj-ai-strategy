---
phase: 30-bbjapi-javadoc-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - rag-ingestion/src/bbj_rag/source_config.py
  - rag-ingestion/src/bbj_rag/ingest_all.py
  - rag-ingestion/src/bbj_rag/url_mapping.py
  - rag-ingestion/sources.toml
autonomous: true

must_haves:
  truths:
    - "`bbj-ingest-all --source javadoc` completes without errors"
    - "Search for 'BBjWindow addButton' returns JavaDoc results"
    - "JavaDoc results have clickable display_url to documentation.basis.cloud"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/source_config.py"
      provides: "javadoc parser registration"
      contains: "javadoc"
    - path: "rag-ingestion/src/bbj_rag/ingest_all.py"
      provides: "javadoc parser factory case"
      contains: "JavaDocParser"
    - path: "rag-ingestion/src/bbj_rag/url_mapping.py"
      provides: "bbj_api:// URL handling"
      contains: "bbj_api://"
    - path: "rag-ingestion/sources.toml"
      provides: "javadoc source entry"
      contains: 'name = "javadoc"'
  key_links:
    - from: "rag-ingestion/src/bbj_rag/ingest_all.py"
      to: "rag-ingestion/src/bbj_rag/parsers/javadoc.py"
      via: "lazy import in factory"
      pattern: "from bbj_rag.parsers.javadoc import JavaDocParser"
    - from: "rag-ingestion/sources.toml"
      to: "ingest_all.py parser factory"
      via: "parser = javadoc"
      pattern: 'parser = "javadoc"'
---

<objective>
Wire the JavaDoc parser into the ingestion pipeline, add the source configuration, and validate end-to-end ingestion and search functionality.

Purpose: Complete the integration so `bbj-ingest-all --source javadoc` works and JavaDoc content is searchable via the RAG API.

Output: Updated configuration files enabling JavaDoc ingestion, plus verified ingestion run.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-bbjapi-javadoc-ingestion/30-CONTEXT.md
@.planning/phases/30-bbjapi-javadoc-ingestion/30-RESEARCH.md
@.planning/phases/30-bbjapi-javadoc-ingestion/30-01-SUMMARY.md

# Files to modify
@rag-ingestion/src/bbj_rag/source_config.py
@rag-ingestion/src/bbj_rag/ingest_all.py
@rag-ingestion/src/bbj_rag/url_mapping.py
@rag-ingestion/sources.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register JavaDoc parser in source configuration</name>
  <files>
rag-ingestion/src/bbj_rag/source_config.py
rag-ingestion/src/bbj_rag/ingest_all.py
rag-ingestion/src/bbj_rag/url_mapping.py
  </files>
  <action>
**1. source_config.py changes:**

Add "javadoc" to `_KNOWN_PARSERS` frozenset:
```python
_KNOWN_PARSERS: frozenset[str] = frozenset(
    {
        "flare",
        "pdf",
        "mdx",
        "bbj-source",
        "wordpress-advantage",
        "wordpress-kb",
        "web-crawl",
        "javadoc",  # ADD THIS
    }
)
```

Add "javadoc" to `_DIR_PARSERS` frozenset (it reads from a directory):
```python
_DIR_PARSERS: frozenset[str] = frozenset({"flare", "mdx", "bbj-source", "javadoc"})
```

Add "javadoc" to `_SOURCE_URL_PREFIXES` dict:
```python
_SOURCE_URL_PREFIXES: dict[str, str] = {
    "flare": "flare://",
    "pdf": "pdf://",
    "bbj-source": "file://",
    "wordpress-advantage": "https://basis.cloud/advantage",
    "wordpress-kb": "https://basis.cloud/knowledge-base",
    "web-crawl": "https://documentation.basis.cloud",
    "javadoc": "bbj_api://",  # ADD THIS
}
```

**2. ingest_all.py changes:**

Add parser factory case in `_create_parser_for_source()` function, after the existing cases:
```python
if parser_type == "javadoc":
    from bbj_rag.parsers.javadoc import JavaDocParser

    return JavaDocParser(
        javadoc_dir=data_dir / source.paths[0],
    )
```

**3. url_mapping.py changes:**

Add to `_SOURCE_TYPE_RULES` list (before the catch-all entries):
```python
("bbj_api://", "BBj API Reference"),
```

Add display URL mapping in `map_display_url()` function. Since display_url is already set by the parser from [Docs] links, just pass through bbj_api:// URLs that have display_url set:
```python
# After the MDX checks, before the https:// passthrough
if source_url.startswith("bbj_api://"):
    # Parser already extracted display_url from [Docs] links
    # Return empty to use the Document's display_url field
    return ""
```
  </action>
  <verify>
```bash
cd rag-ingestion
python -c "
from bbj_rag.source_config import _KNOWN_PARSERS, _DIR_PARSERS, _SOURCE_URL_PREFIXES

# Verify javadoc is registered
assert 'javadoc' in _KNOWN_PARSERS, 'javadoc not in _KNOWN_PARSERS'
assert 'javadoc' in _DIR_PARSERS, 'javadoc not in _DIR_PARSERS'
assert 'javadoc' in _SOURCE_URL_PREFIXES, 'javadoc not in _SOURCE_URL_PREFIXES'
print('source_config.py: OK')

from bbj_rag.url_mapping import classify_source_type
result = classify_source_type('bbj_api://BBjWindow')
assert result == 'BBj API Reference', f'Expected \"BBj API Reference\", got \"{result}\"'
print('url_mapping.py: OK')
"
```
  </verify>
  <done>
- "javadoc" is a valid parser type in source_config.py
- Parser factory can instantiate JavaDocParser
- bbj_api:// URLs are classified as "BBj API Reference"
  </done>
</task>

<task type="auto">
  <name>Task 2: Add JavaDoc source entry and run E2E ingestion</name>
  <files>rag-ingestion/sources.toml</files>
  <action>
**1. Add source entry to sources.toml:**

Add a new section at the end of the file:
```toml
# ---------------------------------------------------------------------------
# 10. JavaDoc -- BBj API documentation from JSON files
# ---------------------------------------------------------------------------
[[sources]]
name = "javadoc"
parser = "javadoc"
paths = ["javadoc"]
generation_tag = "bbj_api"
enabled = true
```

Note: The `paths` value is relative to `data_dir`. The actual JavaDoc files are at `/Users/beff/bbx/documentation/javadoc/`. Configure `DATA_DIR` or create a symlink so that `$DATA_DIR/javadoc` points to the JavaDoc directory.

**2. Create symlink or set environment:**

Option A (symlink - recommended for local dev):
```bash
ln -s /Users/beff/bbx/documentation/javadoc /Users/beff/bbx/documentation/bbjdocs/../javadoc
# Or wherever DATA_DIR points
```

Option B (environment variable):
```bash
export BBJ_HOME=/Users/beff/bbx
# Then update paths in sources.toml to use absolute path or adjust data_dir
```

For this task, use the environment-based approach since the user mentioned using `BBJ_HOME` pattern in CONTEXT.md. Update the parser to read from `$BBJ_HOME/documentation/javadoc/` directly if paths is empty, similar to how wordpress parsers work with no local paths.

**Alternative approach (simpler):** Since the JavaDoc location is fixed at the BBj installation, modify the parser to NOT use data_dir at all - instead read directly from `$BBJ_HOME/documentation/javadoc/` like the wordpress parsers read from hardcoded URLs. Update sources.toml entry:

```toml
[[sources]]
name = "javadoc"
parser = "javadoc"
paths = []  # Parser reads from $BBJ_HOME/documentation/javadoc/
generation_tag = "bbj_api"
enabled = true
```

And update ingest_all.py factory to NOT pass data_dir:
```python
if parser_type == "javadoc":
    from bbj_rag.parsers.javadoc import JavaDocParser
    import os
    bbj_home = os.environ.get("BBJ_HOME", "/usr/local/bbj")
    return JavaDocParser(
        javadoc_dir=Path(bbj_home) / "documentation" / "javadoc",
    )
```

**3. Run ingestion:**
```bash
cd rag-ingestion
export BBJ_HOME=/Users/beff/bbx
bbj-ingest-all --source javadoc --clean
```

**4. Verify search works:**
```bash
# Start the services if not running
docker compose up -d

# Test search via API
curl -s "http://localhost:10800/search?query=BBjWindow%20addButton&limit=5" | python -m json.tool
```
  </action>
  <verify>
```bash
cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion

# Verify sources.toml is valid
python -c "
from bbj_rag.source_config import load_sources_config
from pathlib import Path
cfg = load_sources_config(Path('sources.toml'))
javadoc_source = next((s for s in cfg.sources if s.name == 'javadoc'), None)
assert javadoc_source is not None, 'javadoc source not found'
assert javadoc_source.parser == 'javadoc', 'wrong parser'
print(f'sources.toml: OK - javadoc source found')
"

# Run ingestion (requires Ollama and Postgres running)
export BBJ_HOME=/Users/beff/bbx
bbj-ingest-all --source javadoc --clean 2>&1 | tail -20

# Verify chunks were created
python -c "
from bbj_rag.config import Settings
from bbj_rag.db import get_connection_from_settings
s = Settings()
conn = get_connection_from_settings(s)
cur = conn.cursor()
cur.execute(\"SELECT COUNT(*) FROM chunks WHERE source_url LIKE 'bbj_api://%'\")
count = cur.fetchone()[0]
print(f'JavaDoc chunks in database: {count}')
assert count > 300, f'Expected 300+ chunks, got {count}'
conn.close()
"
```
  </verify>
  <done>
- sources.toml has valid javadoc entry
- `bbj-ingest-all --source javadoc` completes successfully
- 300+ chunks created with source_url starting with `bbj_api://`
- Search query for "BBjWindow addButton" returns relevant results
  </done>
</task>

</tasks>

<verification>
1. All configuration changes are syntactically valid (Python, TOML)
2. `bbj-ingest-all --source javadoc --clean` completes without errors
3. Database contains ~359 chunks from JavaDoc source
4. Search API returns JavaDoc results with display_url values
5. display_url values link to documentation.basis.cloud
</verification>

<success_criteria>
- Ingestion command works: `bbj-ingest-all --source javadoc`
- Chunk count: ~359 classes ingested
- Search returns results: Query "BBjWindow addButton" returns JavaDoc source
- URLs work: display_url values are clickable links to documentation.basis.cloud
</success_criteria>

<output>
After completion, create `.planning/phases/30-bbjapi-javadoc-ingestion/30-02-SUMMARY.md`
</output>
