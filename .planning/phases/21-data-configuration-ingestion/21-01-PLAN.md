---
phase: 21-data-configuration-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/sources.toml
  - rag-ingestion/src/bbj_rag/source_config.py
  - rag-ingestion/src/bbj_rag/parsers/mdx.py
  - rag-ingestion/src/bbj_rag/intelligence/report.py
  - rag-ingestion/.gitignore
autonomous: true

must_haves:
  truths:
    - "sources.toml defines all 9 source entries (6 logical sources = 9 config entries because 3 MDX directories are separate entries sharing the mdx parser, yielding 7 distinct parser types) with paths, parser types, generation tags, and enabled flags"
    - "source_config.py loads and validates sources.toml via Pydantic, enforcing known parser types"
    - "MdxParser accepts a source_prefix parameter to produce unique source_url prefixes per MDX directory"
    - "report.py SQL CASE expressions match the actual source_url prefixes produced by all parsers"
    - ".gitignore includes .ingestion-state.json for resume tracking"
  artifacts:
    - path: "rag-ingestion/sources.toml"
      provides: "Config file defining all 9 source entries with data_dir, paths, parser, generation_tag, enabled"
      contains: "[[sources]]"
    - path: "rag-ingestion/src/bbj_rag/source_config.py"
      provides: "Pydantic models for source config loading and path validation"
      exports: ["SourceEntry", "SourcesConfig", "load_sources_config", "validate_sources"]
    - path: "rag-ingestion/src/bbj_rag/parsers/mdx.py"
      provides: "MdxParser with configurable source_prefix for multi-directory support"
      contains: "source_prefix"
    - path: "rag-ingestion/src/bbj_rag/intelligence/report.py"
      provides: "Updated SQL CASE expressions matching real source_url prefixes"
      contains: "dwc-course://"
  key_links:
    - from: "rag-ingestion/sources.toml"
      to: "rag-ingestion/src/bbj_rag/source_config.py"
      via: "tomllib.load parsed into SourcesConfig Pydantic model"
      pattern: "tomllib\\.load"
    - from: "rag-ingestion/src/bbj_rag/source_config.py"
      to: "rag-ingestion/src/bbj_rag/parsers/mdx.py"
      via: "source.name passed as source_prefix to MdxParser"
      pattern: "source_prefix"
---

<objective>
Create the source configuration infrastructure for all 6 logical BBj documentation sources (9 config entries -- 3 MDX directories are separate entries sharing the "mdx" parser, giving 7 distinct parser types across 9 entries), update the MdxParser for multi-directory support with unique source_url prefixes, and fix the report module's source_url pattern matching.

**Source mapping: 6 logical sources -> 9 config entries:**
- flare (1 entry) -- BBj docs site
- pdf (1 entry) -- GUI programming guide
- mdx (3 entries: mdx-dwc, mdx-beginner, mdx-db-modernization) -- tutorial MDX directories
- bbj-source (1 entry) -- sample BBj source code
- wordpress (2 entries: wordpress-advantage, wordpress-kb) -- CMS content
- web-crawl (1 entry) -- documentation.basis.cloud

Purpose: Establish the config-driven foundation that the orchestration script (Plan 21-02) reads to run ingestion across all sources. Without this, there is no single definition of what sources exist, where they live, and how to identify them.

Output: `sources.toml` config file, `source_config.py` loader/validator, updated `mdx.py` with `source_prefix`, fixed `report.py` SQL patterns.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-data-configuration-ingestion/21-RESEARCH.md

@rag-ingestion/src/bbj_rag/parsers/mdx.py
@rag-ingestion/src/bbj_rag/intelligence/report.py
@rag-ingestion/src/bbj_rag/config.py
@rag-ingestion/src/bbj_rag/models.py
@rag-ingestion/.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sources.toml and source_config.py</name>
  <files>
    rag-ingestion/sources.toml
    rag-ingestion/src/bbj_rag/source_config.py
    rag-ingestion/.gitignore
  </files>
  <action>
    Create `rag-ingestion/sources.toml` defining all 9 source entries using TOML `[[sources]]` array-of-tables syntax:

    **Top-level key:**
    - `data_dir = ""` -- intentionally blank; portable across machines. Resolved at runtime via `DATA_DIR` env var (required) or `--data-dir` CLI override. The TOML file ships without a machine-specific path.

    **9 source entries** (each with name, parser, paths, generation_tag, enabled):
    1. `flare` -- parser=`"flare"`, paths=`["bbjdocs"]`, generation_tag=`"bbj"`, enabled=true
    2. `pdf` -- parser=`"pdf"`, paths=`["bbj-ai-strategy/GuideToGuiProgrammingInBBj.pdf"]`, generation_tag=`"bbj_gui"`, enabled=true
    3. `mdx-dwc` -- parser=`"mdx"`, paths=`["bbj-dwc-tutorial/docs"]`, generation_tag=`"dwc"`, enabled=true
    4. `mdx-beginner` -- parser=`"mdx"`, paths=`["bbj-beginner-tutorial/docs"]`, generation_tag=`"bbj"`, enabled=true
    5. `mdx-db-modernization` -- parser=`"mdx"`, paths=`["bbj-db-modernization-tutorial/docs"]`, generation_tag=`"bbj"`, enabled=true
    6. `bbj-source` -- parser=`"bbj-source"`, paths=`["bbj-dwc-tutorial/samples", "bbj-beginner-tutorial"]`, generation_tag=`"auto"`, enabled=true
    7. `wordpress-advantage` -- parser=`"wordpress-advantage"`, paths=`[]`, generation_tag=`"bbj"`, enabled=true
    8. `wordpress-kb` -- parser=`"wordpress-kb"`, paths=`[]`, generation_tag=`"bbj"`, enabled=true
    9. `web-crawl` -- parser=`"web-crawl"`, paths=`[]`, generation_tag=`"bbj"`, enabled=true

    Add a header comment explaining the file's purpose, the `data_dir` override mechanism, and how to disable sources.

    **Create `rag-ingestion/src/bbj_rag/source_config.py`** with:

    1. `SourceEntry(BaseModel)` -- fields: `name: str`, `parser: str`, `paths: list[str] = []`, `generation_tag: str = "bbj"`, `enabled: bool = True`. Add `@field_validator("parser")` that checks against known set: `{"flare", "pdf", "mdx", "bbj-source", "wordpress-advantage", "wordpress-kb", "web-crawl"}`.

    2. `SourcesConfig(BaseModel)` -- fields: `data_dir: str = ""`, `sources: list[SourceEntry]`.

    3. `load_sources_config(config_path: Path) -> SourcesConfig` -- uses `tomllib.load()` (stdlib) to read the file, validates through `SourcesConfig.model_validate(raw)`.

    4. `resolve_data_dir(config: SourcesConfig) -> Path` -- returns `Path(os.environ["DATA_DIR"])` if env var set, otherwise `Path(config.data_dir)`. Raises `ValueError` if neither is set. This enables Docker (DATA_DIR=/data) vs host (TOML data_dir) portability.

    5. `validate_sources(sources: list[SourceEntry], data_dir: Path) -> list[str]` -- returns list of error strings. For each enabled source:
       - For parsers `"flare"`, `"mdx"`, `"bbj-source"`: check each path is a directory via `(data_dir / path).is_dir()`
       - For parser `"pdf"`: check each path is a file via `(data_dir / path).is_file()`
       - For URL-based parsers (`"wordpress-*"`, `"web-crawl"`): skip path validation (no local paths)
       - Return empty list if all valid.

    6. `get_source_url_prefix(source: SourceEntry) -> str` -- returns the source_url prefix used by each parser. For MDX, returns `f"{source.name}://"`. For others, uses a static map: `{"flare": "flare://", "pdf": "pdf://", "bbj-source": "file://", "wordpress-advantage": "https://basis.cloud/advantage", "wordpress-kb": "https://basis.cloud/knowledge-base", "web-crawl": "https://documentation.basis.cloud"}`.

    All public names in `__all__`.

    **Update `rag-ingestion/.gitignore`** -- add `.ingestion-state.json` entry for resume state tracking.
  </action>
  <verify>
    ```bash
    cd rag-ingestion
    python -c "
    from bbj_rag.source_config import load_sources_config, resolve_data_dir, validate_sources, get_source_url_prefix
    cfg = load_sources_config(Path('sources.toml'))
    assert len(cfg.sources) == 9, f'Expected 9 sources, got {len(cfg.sources)}'
    data_dir = resolve_data_dir(cfg)
    errors = validate_sources([s for s in cfg.sources if s.enabled], data_dir)
    print(f'Validation errors: {errors}')
    # Check MDX source prefixes are unique
    mdx_prefixes = [get_source_url_prefix(s) for s in cfg.sources if s.parser == 'mdx']
    assert len(set(mdx_prefixes)) == 3, 'MDX prefixes must be unique'
    print('source_config.py OK')
    " 2>&1
    ```
    Also verify `.gitignore` contains `.ingestion-state.json`.
  </verify>
  <done>
    sources.toml has 9 entries with correct paths, source_config.py loads/validates it, all local source paths pass validation on the host filesystem, MDX source prefixes are unique per directory, and .ingestion-state.json is gitignored.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MdxParser for multi-directory source_prefix support</name>
  <files>
    rag-ingestion/src/bbj_rag/parsers/mdx.py
  </files>
  <action>
    Modify `MdxParser.__init__` to accept an optional `source_prefix: str = "dwc-course"` parameter. This parameter controls the source_url prefix for all documents yielded by this parser instance.

    **Changes to `__init__`:**
    ```python
    def __init__(self, docs_dir: Path, source_prefix: str = "dwc-course") -> None:
        self._docs_dir = docs_dir
        self._source_prefix = source_prefix
    ```

    **Changes to `parse()`:**
    Replace the hardcoded `"dwc-course://"` prefix with `f"{self._source_prefix}://"`:
    - Line `source_url=f"dwc-course://{relative_path}"` becomes `source_url=f"{self._source_prefix}://{relative_path}"`

    Also update the hardcoded context_header. Currently it says `"DWC Course > ..."`. Derive a human-readable label from the prefix:
    - Add a helper `_prefix_label` property or inline logic: `self._source_prefix.replace("-", " ").replace("_", " ").title()` to produce labels like "Mdx Dwc", "Mdx Beginner", "Mdx Db Modernization".
    - Replace `"DWC Course > {chapter_label} > {title}"` with `f"{label} > {chapter_label} > {title}"` and `"DWC Course > {title}"` with `f"{label} > {title}"`.

    Also update the metadata `"source"` value from the hardcoded `"dwc_course"` to a dynamic value derived from the prefix: `self._source_prefix.replace("-", "_")`.

    **Backward compatibility:** The default `source_prefix="dwc-course"` preserves the existing behavior for the old `bbj-rag ingest --source mdx` CLI command. Existing tests that create `MdxParser(docs_dir=...)` without `source_prefix` continue to work unchanged.

    **Do NOT:**
    - Change the parser interface to accept multiple directories. Each MdxParser instance handles one directory. The orchestration script creates one MdxParser per MDX config entry.
    - Remove or change the default `source_prefix` value -- it must default to `"dwc-course"` for backward compat with the existing CLI.
  </action>
  <verify>
    ```bash
    cd rag-ingestion
    # Run existing MDX parser tests to verify backward compat
    python -m pytest tests/ -k "mdx" -v 2>&1 | tail -20
    # Quick integration check with custom prefix
    python -c "
    from pathlib import Path
    from bbj_rag.parsers.mdx import MdxParser
    # Test default prefix
    p1 = MdxParser(docs_dir=Path('/tmp'))
    assert p1._source_prefix == 'dwc-course'
    # Test custom prefix
    p2 = MdxParser(docs_dir=Path('/tmp'), source_prefix='mdx-beginner')
    assert p2._source_prefix == 'mdx-beginner'
    print('MdxParser source_prefix OK')
    "
    ```
  </verify>
  <done>
    MdxParser accepts source_prefix parameter, defaults to "dwc-course" for backward compat, produces unique source_url prefixes per instance (e.g., "mdx-dwc://path", "mdx-beginner://path"), and all existing MDX tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix report.py source_url SQL patterns for MDX and add web_crawl</name>
  <files>
    rag-ingestion/src/bbj_rag/intelligence/report.py
  </files>
  <action>
    The existing `_query_report_data()` function has a SQL CASE expression that uses `WHEN source_url LIKE 'mdx://%%' THEN 'mdx'` -- but no parser has ever produced `mdx://` URLs. The MdxParser produces `dwc-course://` (and after Task 2, also `mdx-dwc://`, `mdx-beginner://`, `mdx-db-modernization://`). The web crawl parser produces `https://documentation.basis.cloud/...` URLs which currently fall through to 'unknown'.

    **Update the SQL CASE expression** in `_query_report_data()`:

    Replace:
    ```sql
    WHEN source_url LIKE 'mdx://%%' THEN 'mdx'
    ```

    With three patterns that catch all MDX URL prefixes (both old and new):
    ```sql
    WHEN source_url LIKE 'dwc-course://%%' THEN 'mdx'
    WHEN source_url LIKE 'mdx-%%://%%' THEN 'mdx'
    WHEN source_url LIKE '%%documentation.basis.cloud%%' THEN 'web-crawl'
    ```

    Add the `WHEN ... 'web-crawl'` line BEFORE the `ELSE 'unknown'` fallback.

    **Update `_check_anomalies()`:**
    The `expected_sources` set currently is `{"flare", "advantage", "kb", "pdf", "mdx", "bbj-source"}`. Add `"web-crawl"` to this set so the quality report warns if web-crawl chunks are missing.

    **Do NOT:**
    - Change the report output format
    - Add new SQL queries
    - Modify the `build_report()` or `print_report()` functions (those operate on Document objects, not database)
  </action>
  <verify>
    ```bash
    cd rag-ingestion
    python -m pytest tests/ -k "report" -v 2>&1 | tail -20
    # Verify the SQL pattern covers all cases
    python -c "
    import re
    from bbj_rag.intelligence.report import _query_report_data
    import inspect
    src = inspect.getsource(_query_report_data)
    assert 'dwc-course://' in src, 'Missing dwc-course:// pattern'
    assert 'mdx-' in src, 'Missing mdx- pattern'
    assert 'documentation.basis.cloud' in src, 'Missing web-crawl pattern'
    assert 'mdx://' not in src, 'Old mdx:// pattern should be removed'
    print('report.py patterns OK')
    "
    ```
  </verify>
  <done>
    report.py SQL CASE expression matches actual source_url prefixes from all parsers: flare://, pdf://, dwc-course://, mdx-*://, file://, basis.cloud/advantage, basis.cloud/knowledge, documentation.basis.cloud. Expected sources set includes web-crawl. Existing report tests pass.
  </done>
</task>

</tasks>

<verification>
Run the full test suite to ensure no regressions:
```bash
cd rag-ingestion && python -m pytest tests/ -v 2>&1 | tail -30
```

Verify source_config can load and validate the real sources.toml:
```bash
cd rag-ingestion && python -c "
from pathlib import Path
from bbj_rag.source_config import load_sources_config, resolve_data_dir, validate_sources
cfg = load_sources_config(Path('sources.toml'))
data_dir = resolve_data_dir(cfg)
enabled = [s for s in cfg.sources if s.enabled]
errors = validate_sources(enabled, data_dir)
print(f'Sources: {len(cfg.sources)}, Enabled: {len(enabled)}, Errors: {len(errors)}')
for e in errors: print(f'  ERROR: {e}')
for s in enabled: print(f'  {s.name}: parser={s.parser}, tag={s.generation_tag}')
"
```
</verification>

<success_criteria>
1. sources.toml exists with 9 source entries (6 logical sources = 9 config entries; 7 distinct parser types with MDX used 3 times)
2. sources.toml ships with `data_dir = ""` (no hardcoded machine path); resolution requires DATA_DIR env var or --data-dir CLI override
3. source_config.py loads, validates, and resolves paths from sources.toml
4. MdxParser produces unique source_url prefixes per directory (mdx-dwc://, mdx-beginner://, mdx-db-modernization://)
5. report.py SQL patterns match all actual source_url prefixes
6. All existing tests pass (no regressions from MdxParser or report changes)
</success_criteria>

<output>
After completion, create `.planning/phases/21-data-configuration-ingestion/21-01-SUMMARY.md`
</output>
