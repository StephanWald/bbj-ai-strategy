---
phase: 27-remote-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/src/bbj_rag/app.py
  - rag-ingestion/src/bbj_rag/mcp_server.py
  - rag-ingestion/docker-compose.yml
  - README.md
autonomous: true

must_haves:
  truths:
    - "Claude Desktop on a remote machine connects to http://server:10800/mcp and executes search_bbj_knowledge"
    - "Browser on a remote machine opens http://server:10800/chat and submits queries"
    - "docker compose up binds services to 0.0.0.0 (accessible from LAN)"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/app.py"
      provides: "MCP HTTP endpoint mounted at /mcp"
      contains: "streamable_http_app"
    - path: "rag-ingestion/docker-compose.yml"
      provides: "Network binding to 0.0.0.0"
      contains: "0.0.0.0:10800"
    - path: "README.md"
      provides: "Remote access deployment instructions"
      contains: "mcp-remote"
  key_links:
    - from: "rag-ingestion/src/bbj_rag/app.py"
      to: "rag-ingestion/src/bbj_rag/mcp_server.py"
      via: "mcp.streamable_http_app() mounted on FastAPI"
      pattern: "app\\.mount.*mcp"
    - from: "Claude Desktop config"
      to: "/mcp endpoint"
      via: "npx mcp-remote with --allow-http"
      pattern: "mcp-remote.*--allow-http"
---

<objective>
Enable engineers on the local network to access the BBj RAG system (chat UI + MCP server) from their own machines without running Docker locally.

Purpose: This completes the alpha deployment story - engineers can connect Claude Desktop to the shared MCP server and use the chat interface from any machine on the LAN.

Output:
- FastAPI app with MCP Streamable HTTP endpoint at `/mcp`
- Docker Compose binding to 0.0.0.0 for LAN access
- README with deployment instructions and Claude Desktop config snippet
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-remote-access/27-CONTEXT.md
@.planning/phases/27-remote-access/27-RESEARCH.md

# Current architecture
@rag-ingestion/src/bbj_rag/app.py
@rag-ingestion/src/bbj_rag/mcp_server.py
@rag-ingestion/docker-compose.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mount MCP Streamable HTTP endpoint on FastAPI</name>
  <files>
    rag-ingestion/src/bbj_rag/app.py
    rag-ingestion/src/bbj_rag/mcp_server.py
  </files>
  <action>
    Modify the FastAPI app to mount the MCP Streamable HTTP endpoint at `/mcp`.

    In `mcp_server.py`:
    1. Update the FastMCP instantiation to enable stateless HTTP mode:
       ```python
       mcp = FastMCP(
           "bbj-knowledge",
           stateless_http=True,
           streamable_http_path="/",  # Serve at mount point, not /mcp/mcp
       )
       ```
    2. Add an export for the mcp instance so app.py can import it
    3. Keep the existing stdio `main()` entry point for backward compatibility (local Claude Desktop)

    In `app.py`:
    1. Import mcp from mcp_server module
    2. Update the lifespan handler to include MCP session manager:
       ```python
       async with mcp.session_manager.run():
           yield
       ```
       The MCP session manager context MUST wrap the yield statement.
    3. After router includes but before static files mount, add:
       ```python
       app.mount("/mcp", mcp.streamable_http_app())
       ```

    IMPORTANT - Lifespan pitfall from research:
    - "Task group is not initialized" error occurs if mcp.session_manager.run() is not called
    - The combined lifespan must call both the existing startup logic AND the MCP session manager

    IMPORTANT - Path pitfall from research:
    - Configure `streamable_http_path="/"` in FastMCP constructor
    - Then mount at `/mcp` in FastAPI
    - This avoids double-prefix issue (/mcp/mcp)
  </action>
  <verify>
    1. `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run ruff check src/bbj_rag/app.py src/bbj_rag/mcp_server.py`
    2. `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run mypy src/bbj_rag/app.py src/bbj_rag/mcp_server.py`
    3. `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run pytest tests/ -x -q`
  </verify>
  <done>
    - mcp_server.py has FastMCP configured with stateless_http=True and streamable_http_path="/"
    - app.py imports mcp and mounts streamable_http_app() at /mcp
    - Lifespan handler includes mcp.session_manager.run() context
    - All linting and tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Docker Compose for 0.0.0.0 binding and add README deployment instructions</name>
  <files>
    rag-ingestion/docker-compose.yml
    README.md
  </files>
  <action>
    **Docker Compose changes:**

    Update `docker-compose.yml` to explicitly bind to 0.0.0.0:
    1. Change the app ports line from:
       ```yaml
       ports:
         - "${APP_PORT_EXTERNAL:-10800}:8000"
       ```
       to:
       ```yaml
       ports:
         - "0.0.0.0:${APP_PORT_EXTERNAL:-10800}:8000"
       ```

    2. The database port can remain as-is (internal only) or also bind to 0.0.0.0 if needed for debugging:
       ```yaml
       ports:
         - "0.0.0.0:${DB_PORT_EXTERNAL:-10432}:5432"
       ```
       (Optional - only if engineers need direct DB access from other machines)

    **README.md updates:**

    Add a "## Deployment" section (after "Getting Started") with:

    1. **Shared Server Setup** subsection:
       - Prerequisites: Docker, Ollama running on host
       - Environment setup: copy .env.example, set ANTHROPIC_API_KEY
       - Start command: `cd rag-ingestion && docker compose up -d`
       - Access URLs: `http://<server-ip>:10800/chat` for web, `http://<server-ip>:10800/mcp` for MCP
       - Note: Port 10800 must be accessible on the network (firewall)

    2. **Claude Desktop Configuration** subsection:
       - Explain that Claude Desktop uses mcp-remote to connect to HTTP MCP servers
       - Provide copy-paste JSON config for claude_desktop_config.json:
         ```json
         {
           "mcpServers": {
             "bbj-knowledge": {
               "command": "npx",
               "args": [
                 "mcp-remote@latest",
                 "http://192.168.1.100:10800/mcp",
                 "--allow-http"
               ]
             }
           }
         }
         ```
       - Note: Replace 192.168.1.100 with actual server IP
       - Config file locations: macOS `~/Library/Application Support/Claude/claude_desktop_config.json`, Windows `%APPDATA%\Claude\claude_desktop_config.json`

    3. **Troubleshooting** subsection (brief):
       - "Connection refused" - Check server IP and that Docker is running
       - "Task group not initialized" - MCP SDK lifespan error (internal, shouldn't happen)
       - "--allow-http required" - mcp-remote blocks HTTP by default for security

    Keep the README concise - this is internal alpha documentation.
  </action>
  <verify>
    1. `grep -q "0.0.0.0" /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion/docker-compose.yml` - confirms 0.0.0.0 binding
    2. `grep -q "mcp-remote" /Users/beff/_workspace/bbj-ai-strategy/README.md` - confirms Claude Desktop config documented
    3. `grep -q "Deployment" /Users/beff/_workspace/bbj-ai-strategy/README.md` - confirms section exists
  </verify>
  <done>
    - docker-compose.yml binds app port to 0.0.0.0
    - README.md has Deployment section with shared server setup instructions
    - README.md has copy-paste Claude Desktop config with mcp-remote
    - README.md has brief troubleshooting notes
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification (Docker rebuild and endpoint test)</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
    Verify the complete remote access flow works:

    1. Rebuild Docker image to pick up code changes:
       ```bash
       cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion
       docker compose build app
       docker compose up -d
       ```

    2. Wait for healthy status:
       ```bash
       docker compose ps
       ```

    3. Test MCP HTTP endpoint responds:
       ```bash
       curl -v http://localhost:10800/mcp
       ```
       Expected: HTTP response (may be 405 Method Not Allowed for GET, but endpoint exists)

    4. Test MCP POST endpoint with minimal payload:
       ```bash
       curl -X POST http://localhost:10800/mcp \
         -H "Content-Type: application/json" \
         -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'
       ```
       Expected: JSON-RPC response with server capabilities

    5. Verify chat still works:
       ```bash
       curl -s http://localhost:10800/chat | head -20
       ```
       Expected: HTML page content

    6. Check binding address:
       ```bash
       docker compose port app 8000
       ```
       Expected: Shows 0.0.0.0:10800 (or configured port)

    If any step fails, check logs with `docker compose logs app`.
  </action>
  <verify>
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:10800/mcp` returns non-5xx status
    - `docker compose port app 8000` shows 0.0.0.0 binding
    - Chat page loads at http://localhost:10800/chat
  </verify>
  <done>
    - Docker services running with MCP HTTP endpoint active
    - /mcp endpoint responds to HTTP requests
    - 0.0.0.0 binding confirmed via docker compose port
    - Chat UI still accessible
  </done>
</task>

</tasks>

<verification>
Phase 27 requirements verification:

1. **REMOTE-01**: MCP server supports Streamable HTTP transport
   - Test: `curl -X POST http://localhost:10800/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'`
   - Expected: JSON response listing search_bbj_knowledge tool

2. **REMOTE-02**: Chat UI accessible from other machines
   - Test: From another machine, `curl http://<server-ip>:10800/chat`
   - Expected: HTML page loads (requires LAN test, verified locally via 0.0.0.0 binding)

3. **REMOTE-03**: Docker Compose binds to 0.0.0.0
   - Test: `grep "0.0.0.0" docker-compose.yml`
   - Expected: Port binding shows 0.0.0.0
</verification>

<success_criteria>
- MCP Streamable HTTP endpoint mounted at /mcp on the FastAPI app
- Docker Compose explicitly binds to 0.0.0.0:10800
- README.md documents shared server deployment and Claude Desktop configuration
- All existing tests pass (no regressions)
- Docker services start successfully with new MCP endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/27-remote-access/27-01-SUMMARY.md`
</output>
