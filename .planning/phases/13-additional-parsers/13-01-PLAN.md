---
phase: 13-additional-parsers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/src/bbj_rag/parsers/pdf.py
  - rag-ingestion/src/bbj_rag/parsers/bbj_source.py
  - rag-ingestion/tests/test_pdf_parser.py
  - rag-ingestion/tests/test_bbj_source_parser.py
  - rag-ingestion/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "PDF parser extracts text from GuideToGuiProgrammingInBBj.pdf with code blocks and tables preserved"
    - "PDF parser splits the 47-page document into section-level Documents at heading boundaries"
    - "PDF parser runs generation tagger per section (not uniform tag)"
    - "BBj source code parser processes .bbj/.txt files and identifies them as code examples"
    - "BBj source code parser distinguishes dwc from bbj_gui based on API usage patterns"
    - "BBj source code parser extracts leading rem comment blocks as description context"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/parsers/pdf.py"
      provides: "PdfParser implementing DocumentParser protocol"
      contains: "class PdfParser"
    - path: "rag-ingestion/src/bbj_rag/parsers/bbj_source.py"
      provides: "BbjSourceParser implementing DocumentParser protocol"
      contains: "class BbjSourceParser"
    - path: "rag-ingestion/tests/test_pdf_parser.py"
      provides: "Unit tests for PDF parser"
    - path: "rag-ingestion/tests/test_bbj_source_parser.py"
      provides: "Unit tests for BBj source parser"
  key_links:
    - from: "rag-ingestion/src/bbj_rag/parsers/pdf.py"
      to: "bbj_rag.models.Document"
      via: "yield Document(...)"
      pattern: "yield Document\\("
    - from: "rag-ingestion/src/bbj_rag/parsers/bbj_source.py"
      to: "bbj_rag.models.Document"
      via: "yield Document(...)"
      pattern: "yield Document\\("
    - from: "rag-ingestion/src/bbj_rag/parsers/bbj_source.py"
      to: "generation classification"
      via: "DWC vs GUI pattern matching"
      pattern: "_DWC_PATTERNS|_GUI_PATTERNS"
---

<objective>
Implement the PDF parser (pymupdf4llm) for GuideToGuiProgrammingInBBj.pdf and the BBj source code parser for .bbj/.txt sample files. Both are local-file parsers implementing the DocumentParser protocol.

Purpose: These two parsers cover the PDF standalone document source (PARSE-04) and BBj source code source (PARSE-08), which are both file-based and can be built independently from the web crawl parsers.

Output: Two new parser modules with unit tests, plus pymupdf4llm and python-frontmatter dependencies added to pyproject.toml.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-additional-parsers/13-CONTEXT.md
@.planning/phases/13-additional-parsers/13-RESEARCH.md

# Existing parser pattern to follow
@rag-ingestion/src/bbj_rag/parsers/__init__.py
@rag-ingestion/src/bbj_rag/models.py
@rag-ingestion/src/bbj_rag/parsers/web_crawl.py
@rag-ingestion/pyproject.toml

# PDF file to parse
@GuideToGuiProgrammingInBBj.pdf
</context>

<tasks>

<task type="auto">
  <name>Task 1: PDF parser and BBj source code parser</name>
  <files>
    rag-ingestion/src/bbj_rag/parsers/pdf.py
    rag-ingestion/src/bbj_rag/parsers/bbj_source.py
    rag-ingestion/pyproject.toml
  </files>
  <action>
**Add dependencies to pyproject.toml:**
Add `"pymupdf4llm>=0.2.9"` and `"python-frontmatter>=1.1,<2"` to the `dependencies` list. pymupdf4llm is for PDF extraction; python-frontmatter is needed by Plan 13-03 for MDX parsing but adding it now keeps dependency changes in one commit.

**Create `parsers/pdf.py` -- PdfParser class:**

Implement `PdfParser` with `__init__(self, pdf_path: Path)` and `parse() -> Iterator[Document]`.

Key implementation details:
- Use `pymupdf4llm.to_markdown()` with `page_chunks=True` and `write_images=False` (user decision: strip images)
- Try `pymupdf4llm.TocHeaders(doc)` first for heading detection (PDF has a TOC). If it fails or returns empty, fall back to `pymupdf4llm.IdentifyHeaders(doc, max_levels=3)`
- Concatenate all page markdown, then split at `## ` and `# ` heading boundaries to produce section-level Documents (NOT one Document per page -- the PDF has ~15 major sections spanning multiple pages)
- For each section Document:
  - `source_url`: `"pdf://{pdf_filename}#{section_title_slug}"` (e.g., `"pdf://GuideToGuiProgrammingInBBj.pdf#event-driven-programming"`)
  - `title`: The heading text of that section
  - `doc_type`: Set to `"concept"` for prose sections, `"example"` for sections containing code blocks (detect via triple-backtick presence), `"tutorial"` for AppBuilder/Barista sections
  - `generations`: Run content-based classification per section. Import and reuse `tag_generation` from `bbj_rag.intelligence` with empty path and empty conditions (since PDF has no Flare metadata), OR implement inline logic: scan for DWC patterns (BBjHtmlView, setCss, webManager) -> `["dwc"]`, GUI patterns (SYSGUI, addWindow, PROCESS_EVENTS, BBjAPI) -> `["bbj_gui"]`, character patterns (PRINT, OPEN, READ) -> `["character"]`, otherwise `["all"]`
  - `context_header`: `"Guide to GUI Programming > {Section Title}"`
  - `metadata`: `{"source": "pdf", "pdf_file": pdf_filename}`
  - `deprecated`: False
- Skip the TOC page (page 1) -- it's an index, not content
- Log progress: number of sections extracted

**Create `parsers/bbj_source.py` -- BbjSourceParser class:**

Implement `BbjSourceParser` with `__init__(self, source_dirs: list[Path], extensions: list[str] | None = None)` and `parse() -> Iterator[Document]`.

Key implementation details:
- Default extensions: `[".bbj", ".txt", ".src"]`
- For each directory in `source_dirs`, recursively glob for files matching extensions
- Before processing, validate the file looks like BBj code: check for BBj keywords (`rem`, `open`, `print`, `PROCESS_EVENTS`, `class public`, `method public`, `BBjAPI`, `SYSGUI`) -- if none found, skip with a debug log warning
- Extract leading `rem` comment block as description context using `extract_header_comment()` helper (see RESEARCH.md for pattern: consecutive `rem` lines at file start)
- Generation tagging via API pattern analysis:
  - Define `_DWC_PATTERNS` list of compiled regexes: `BBjHtmlView`, `BBjWebComponent`, `setCss|addStyle|getStyle`, `setResponsive`, `BBjNavigator`, `webManager|getWebManager`, `setAttribute.*dwc-`, `.css(`
  - Define `_GUI_PATTERNS`: `BBjAPI()`, `getSysGui`, `PROCESS_EVENTS`, `addWindow|addButton|addEditBox`, `setCallback`, `BBjTopLevelWindow`, `SYSGUI`
  - If any DWC pattern matches -> `["dwc"]`. If any GUI pattern matches -> `["bbj_gui"]`. Otherwise -> `["all"]`
  - Domain insight: DWC is a superset of GUI, so `bbj_gui` code IS relevant to DWC users, but `dwc`-specific code is NOT relevant to traditional GUI
- For each valid file yield Document:
  - `source_url`: `"file://{relative_path}"` (relative to source_dir)
  - `title`: Filename stem (e.g., `"cust-gui"` from `cust-gui.txt`)
  - `doc_type`: `"example"` (all source code files are examples)
  - `content`: Full file content (source files are typically small enough for single-document treatment)
  - `context_header`: `"BBj Source Code > {filename}"` with description from header comment if found: `"BBj Source Code > {filename} -- {description}"`
  - `metadata`: `{"source": "bbj_source", "file_ext": ext, "header_comment": comment}`
  - `generations`: From the pattern analysis above
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv sync` to install new dependencies.
Run `uv run python -c "import pymupdf4llm; print(pymupdf4llm.__version__)"` to confirm pymupdf4llm installed.
Run `uv run python -c "from bbj_rag.parsers.pdf import PdfParser; print('OK')"` to confirm import works.
Run `uv run python -c "from bbj_rag.parsers.bbj_source import BbjSourceParser; print('OK')"` to confirm import works.
Run `uv run ruff check src/bbj_rag/parsers/pdf.py src/bbj_rag/parsers/bbj_source.py` for lint.
Run `uv run mypy src/bbj_rag/parsers/pdf.py src/bbj_rag/parsers/bbj_source.py` for type checking.
  </verify>
  <done>
PdfParser and BbjSourceParser classes exist, import cleanly, pass lint and type checks, and pymupdf4llm + python-frontmatter are installed as dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for PDF and BBj source parsers</name>
  <files>
    rag-ingestion/tests/test_pdf_parser.py
    rag-ingestion/tests/test_bbj_source_parser.py
  </files>
  <action>
**Create `tests/test_pdf_parser.py`:**

Test the PdfParser without requiring the actual 47-page PDF (use mocking for pymupdf4llm calls).

Tests to write:
1. `test_pdf_parser_implements_protocol` -- `isinstance(PdfParser(Path("dummy.pdf")), DocumentParser)` returns True
2. `test_pdf_parser_yields_documents` -- Mock `pymupdf4llm.to_markdown()` to return a multi-section markdown string with `# Section One\nContent\n## Section Two\nMore content`. Verify parser yields Document objects with correct titles and content.
3. `test_pdf_parser_splits_at_headings` -- Mock pymupdf4llm to return markdown with 3 sections. Verify 3 Documents yielded (not 1 for entire PDF).
4. `test_pdf_parser_sets_source_url` -- Verify source_url follows `pdf://filename#section-slug` pattern.
5. `test_pdf_parser_sets_context_header` -- Verify context_header includes "Guide to GUI Programming > Section Title".
6. `test_pdf_parser_detects_code_sections` -- Section with triple-backtick code block gets `doc_type="example"`, section without gets `doc_type="concept"`.
7. `test_pdf_parser_skips_empty_sections` -- Section with only whitespace after heading is not yielded.
8. `test_pdf_parser_generation_tagging` -- Section containing "SYSGUI" gets `["bbj_gui"]`, section containing "BBjHtmlView" gets `["dwc"]`, section with neither gets `["all"]`.

Mock strategy: Use `unittest.mock.patch` on `pymupdf4llm.to_markdown` and `pymupdf.open`. Create fixture markdown strings that represent realistic PDF output.

**Create `tests/test_bbj_source_parser.py`:**

Test BbjSourceParser using temporary directories with sample files.

Tests to write:
1. `test_bbj_source_parser_implements_protocol` -- isinstance check
2. `test_bbj_source_parser_yields_documents` -- Create temp dir with a `.bbj` file containing `rem Sample\nPROCESS_EVENTS`. Verify Document yielded.
3. `test_bbj_source_parser_extracts_header_comment` -- File starting with `rem This is a description\nrem More info\nPROCESS_EVENTS` yields Document with header comment in metadata.
4. `test_bbj_source_parser_classifies_dwc` -- File containing `BBjHtmlView` gets `["dwc"]`.
5. `test_bbj_source_parser_classifies_gui` -- File containing `SYSGUI` and `PROCESS_EVENTS` gets `["bbj_gui"]`.
6. `test_bbj_source_parser_classifies_all` -- File with only `rem` comments and generic code gets `["all"]`.
7. `test_bbj_source_parser_skips_non_bbj_files` -- File with `.txt` extension but no BBj keywords is skipped.
8. `test_bbj_source_parser_multiple_extensions` -- Parser finds `.bbj`, `.txt`, and `.src` files.
9. `test_bbj_source_parser_sets_doc_type_example` -- All source files get `doc_type="example"`.
10. `test_bbj_source_parser_context_header` -- Verify context_header includes filename and description.

Use `tmp_path` pytest fixture for temp directories. Write actual BBj-like content in temp files.
  </action>
  <verify>
Run full test suite: `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run pytest tests/test_pdf_parser.py tests/test_bbj_source_parser.py -v`
All tests pass.
Run `uv run pytest` (full suite) to confirm no regressions.
Run `uv run ruff check tests/test_pdf_parser.py tests/test_bbj_source_parser.py` for lint.
  </verify>
  <done>
18 unit tests (8 PDF + 10 BBj source) all pass. Full test suite shows no regressions. PdfParser correctly splits PDF into section-level Documents with per-section generation tagging. BbjSourceParser correctly processes BBj files with DWC/GUI pattern detection and header comment extraction.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest` -- full suite passes (existing + new tests)
2. `uv run ruff check src/ tests/` -- no lint errors
3. `uv run mypy src/bbj_rag/parsers/pdf.py src/bbj_rag/parsers/bbj_source.py` -- type checks pass
4. `isinstance(PdfParser(...), DocumentParser)` -- True
5. `isinstance(BbjSourceParser(...), DocumentParser)` -- True
</verification>

<success_criteria>
- PdfParser extracts sections from PDF markdown output with heading-boundary splitting
- Each PDF section has per-section generation tagging (not uniform)
- BbjSourceParser processes files from configurable directories with configurable extensions
- DWC vs GUI generation classification works via API pattern matching
- Leading rem comments extracted as description context
- 18+ unit tests pass without requiring actual PDF file or real BBj installations
- No regressions in existing 240+ tests
</success_criteria>

<output>
After completion, create `.planning/phases/13-additional-parsers/13-01-SUMMARY.md`
</output>
