---
phase: 25-result-quality-foundation
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - rag-ingestion/src/bbj_rag/search.py
  - rag-ingestion/src/bbj_rag/api/schemas.py
  - rag-ingestion/src/bbj_rag/api/routes.py
  - rag-ingestion/src/bbj_rag/mcp_server.py
autonomous: true

must_haves:
  truths:
    - "SearchResult dataclass includes display_url and source_type fields"
    - "API /search response includes display_url, source_type on every result, and source_type_counts in metadata"
    - "MCP search_bbj_knowledge renders display_url as the primary source link"
    - "When a single source type dominates results (>=80%), minority sources get a 1.3x score boost"
    - "Diversity reranking only triggers on dominated result sets, not naturally diverse ones"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/search.py"
      provides: "SearchResult with display_url/source_type + rerank_for_diversity()"
      contains: "rerank_for_diversity"
    - path: "rag-ingestion/src/bbj_rag/api/schemas.py"
      provides: "SearchResultItem with display_url/source_type, SearchResponse with source_type_counts"
      contains: "source_type_counts"
    - path: "rag-ingestion/src/bbj_rag/api/routes.py"
      provides: "Diversity reranking call, source_type_counts computation, new fields in response"
      contains: "rerank_for_diversity"
    - path: "rag-ingestion/src/bbj_rag/mcp_server.py"
      provides: "display_url and source_type in formatted output"
      contains: "display_url"
  key_links:
    - from: "rag-ingestion/src/bbj_rag/api/routes.py"
      to: "rag-ingestion/src/bbj_rag/search.py"
      via: "calls rerank_for_diversity() on hybrid search results"
      pattern: "rerank_for_diversity"
    - from: "rag-ingestion/src/bbj_rag/api/routes.py"
      to: "rag-ingestion/src/bbj_rag/api/schemas.py"
      via: "constructs SearchResultItem with display_url and source_type"
      pattern: "display_url.*source_type"
    - from: "rag-ingestion/src/bbj_rag/mcp_server.py"
      to: "REST API /search response"
      via: "reads display_url and source_type from JSON response"
      pattern: "display_url"
---

<objective>
Add display_url and source_type fields to the search response chain (SearchResult -> API schemas -> REST response -> MCP formatting), and implement source-balanced diversity reranking to promote minority source types in dominated result sets.

Purpose: This makes every search result carry a clickable link and source type label, and ensures that PDF, BBj Source, and MDX content can surface in results even when Flare dominates the corpus. These are the user-facing changes that fulfill QUAL-01, QUAL-02, and QUAL-03.

Output: Enriched search responses with display_url, source_type, source_type_counts, and diversity-boosted ranking.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-result-quality-foundation/25-CONTEXT.md
@.planning/phases/25-result-quality-foundation/25-RESEARCH.md
@.planning/phases/25-result-quality-foundation/25-01-SUMMARY.md

@rag-ingestion/src/bbj_rag/search.py
@rag-ingestion/src/bbj_rag/api/schemas.py
@rag-ingestion/src/bbj_rag/api/routes.py
@rag-ingestion/src/bbj_rag/mcp_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich SearchResult and add diversity reranking to search.py</name>
  <files>
    rag-ingestion/src/bbj_rag/search.py
  </files>
  <action>
**SearchResult dataclass changes:**
Add two new fields after `score`:
- `display_url: str`
- `source_type: str`

**_rows_to_results() changes:**
The SQL SELECT columns now include `display_url` and `source_type`. Update the column index mapping. The new SELECT column order will be:
`id(0), source_url(1), title(2), content(3), doc_type(4), generations(5), context_header(6), deprecated(7), score(8), display_url(9), source_type(10)`

Update all 4 search functions (dense_search, bm25_search, hybrid_search, async_hybrid_search) to include `display_url, source_type` in their SELECT column lists -- add them after `deprecated` and before the score expression. The column positions in the SQL should be:
`SELECT id, source_url, title, content, doc_type, generations, context_header, deprecated, display_url, source_type, {score_expression} AS score`

For hybrid_search and async_hybrid_search, add `display_url, source_type` to the GROUP BY clause as well (after `deprecated`).

**rerank_for_diversity() function:**
Add a new module-level dict and function:

```python
# Diversity boost factors for underrepresented source types.
SOURCE_BOOST: dict[str, float] = {
    "pdf": 1.3,
    "bbj_source": 1.3,
    "mdx": 1.2,
    "wordpress": 1.0,
    "web_crawl": 1.0,
    "flare": 1.0,
    "unknown": 1.0,
}
DOMINATION_THRESHOLD = 0.8

def rerank_for_diversity(
    results: list[SearchResult],
    limit: int,
    domination_threshold: float = DOMINATION_THRESHOLD,
) -> list[SearchResult]:
```

Algorithm:
1. If `len(results) == 0`, return empty list
2. Count occurrences of each `source_type` in results
3. Check if any single source_type constitutes >= `domination_threshold` fraction of results
4. If NOT dominated, return `results[:limit]` unchanged (natural diversity is fine)
5. If dominated, apply multiplicative boost: for each result, compute `adjusted_score = result.score * SOURCE_BOOST.get(result.source_type, 1.0)`
6. Sort by adjusted_score descending
7. Return top `limit` results -- create new SearchResult instances with the adjusted score (use `dataclasses.replace()` since SearchResult is frozen)

Add `rerank_for_diversity` and `SOURCE_BOOST` to `__all__`.
  </action>
  <verify>
`cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run python -c "from bbj_rag.search import SearchResult, rerank_for_diversity; print('OK')"` -- imports without error.
  </verify>
  <done>
SearchResult has display_url and source_type fields. All 4 search functions SELECT the new columns. rerank_for_diversity() applies multiplicative boost only when a single source type dominates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update API schemas, routes, and MCP server formatting</name>
  <files>
    rag-ingestion/src/bbj_rag/api/schemas.py
    rag-ingestion/src/bbj_rag/api/routes.py
    rag-ingestion/src/bbj_rag/mcp_server.py
  </files>
  <action>
**schemas.py changes:**
Add to `SearchResultItem` (after `deprecated`, before `score`):
- `display_url: str`
- `source_type: str`

Add to `SearchResponse` (after `count`):
- `source_type_counts: dict[str, int] = Field(default_factory=dict, description="Count of results per source type")`

**routes.py changes:**
In the `search()` endpoint:

1. Import `rerank_for_diversity` from `bbj_rag.search`.
2. After calling `async_hybrid_search()`, apply diversity reranking. Over-fetch by requesting `limit * 2` from the search, then rerank:
   ```python
   # Over-fetch for diversity reranking
   raw_results = await async_hybrid_search(
       conn=conn,
       query_embedding=embedding,
       query_text=body.query,
       limit=body.limit * 2,  # Over-fetch for diversity pool
       generation_filter=gen_filter,
   )

   # Apply diversity reranking
   results = rerank_for_diversity(raw_results, limit=body.limit)
   ```
3. Build `source_type_counts` from the final results:
   ```python
   from collections import Counter
   source_type_counts = dict(Counter(r.source_type for r in results))
   ```
4. Update `SearchResultItem` construction to include `display_url=r.display_url` and `source_type=r.source_type`.
5. Pass `source_type_counts=source_type_counts` to the `SearchResponse` constructor.

**mcp_server.py changes:**
Update `_format_results()` to render display_url and source_type:
- Replace `parts.append(f"Source: {r['source_url']}")` with:
  ```python
  display = r.get('display_url', r['source_url'])
  parts.append(f"Source: {display}")
  if r.get('source_type'):
      parts.append(f"Source Type: {r['source_type']}")
  ```
- After the results blocks, if `data.get('source_type_counts')`:
  ```python
  counts = data.get('source_type_counts', {})
  if counts:
      summary = ", ".join(f"{k}: {v}" for k, v in sorted(counts.items()))
      # Prepend to the output header
  ```
  Update the header line to include source breakdown: `f"Found {len(results)} results for: {query} ({summary})"` when counts exist.
  </action>
  <verify>
1. `cd /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion && uv run python -c "from bbj_rag.api.schemas import SearchResultItem, SearchResponse; print(SearchResultItem.model_fields.keys()); print(SearchResponse.model_fields.keys())"` -- shows display_url, source_type, source_type_counts in the field lists.
2. `uv run python -c "from bbj_rag.api.routes import router; print('OK')"` -- imports without error.
3. `uv run python -c "from bbj_rag.mcp_server import _format_results; print('OK')"` -- imports without error.
  </verify>
  <done>
API response includes display_url and source_type on every result item plus source_type_counts in metadata. Routes call rerank_for_diversity with over-fetch. MCP server renders display_url as primary source link with source_type label.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from bbj_rag.search import SearchResult, rerank_for_diversity, SOURCE_BOOST; print('search OK')"` -- no import errors
2. `uv run python -c "from bbj_rag.api.schemas import SearchResultItem; assert 'display_url' in SearchResultItem.model_fields; assert 'source_type' in SearchResultItem.model_fields; print('schemas OK')"` -- fields present
3. `uv run python -c "from bbj_rag.api.schemas import SearchResponse; assert 'source_type_counts' in SearchResponse.model_fields; print('response OK')"` -- metadata field present
4. `uv run pytest tests/ -v -k "not test_mcp and not test_e2e"` -- existing tests pass with updated imports
</verification>

<success_criteria>
- SearchResult dataclass has display_url and source_type fields
- All 4 search functions (dense, bm25, hybrid, async_hybrid) SELECT display_url and source_type
- rerank_for_diversity() exists and applies score boost only when dominated
- SearchResultItem schema has display_url and source_type
- SearchResponse schema has source_type_counts
- /search route calls rerank_for_diversity with over-fetch
- MCP _format_results shows display_url as primary source link
- No import errors across the chain
</success_criteria>

<output>
After completion, create `.planning/phases/25-result-quality-foundation/25-02-SUMMARY.md`
</output>
