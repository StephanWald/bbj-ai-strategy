---
phase: 28-compiler-validation
plan: 03
type: execute
wave: 3
depends_on: ["28-02"]
files_modified:
  - rag-ingestion/src/bbj_rag/static/chat.js
  - rag-ingestion/src/bbj_rag/static/chat.css
autonomous: false

must_haves:
  truths:
    - "Failed validation shows warning banner above the code block"
    - "Warning includes full bbjcpl stderr output"
    - "Valid code displays cleanly with no indicator"
    - "Warning is always visible (not dismissible)"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/static/chat.js"
      provides: "validation_warning event handling"
      contains: "validation_warning"
    - path: "rag-ingestion/src/bbj_rag/static/chat.css"
      provides: "Warning banner styling"
      contains: "validation-warning"
  key_links:
    - from: "rag-ingestion/src/bbj_rag/static/chat.js"
      to: "SSE validation_warning event"
      via: "handleEvent switch case"
      pattern: "case 'validation_warning'"
---

<objective>
Add frontend support for displaying validation warnings on BBj code blocks that failed compiler validation after all retry attempts.

Purpose: Engineers see clear warnings when code couldn't be validated, with full compiler error output so they can understand and fix issues manually.

Output: Modified chat.js and chat.css with validation warning UI.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-compiler-validation/28-CONTEXT.md
@.planning/phases/28-compiler-validation/28-02-SUMMARY.md
@rag-ingestion/src/bbj_rag/static/chat.js
@rag-ingestion/src/bbj_rag/static/chat.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation warning styles</name>
  <files>
    rag-ingestion/src/bbj_rag/static/chat.css
  </files>
  <action>
Add CSS for validation warning banners to chat.css:

```css
/* Validation warning banner - appears above code blocks that failed validation */
.validation-warning {
  background: #fef3c7;  /* Amber-100 */
  border: 1px solid #f59e0b;  /* Amber-500 */
  border-radius: 6px;
  padding: 12px 16px;
  margin-bottom: 8px;
  font-size: 14px;
}

.validation-warning-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #92400e;  /* Amber-800 */
  margin-bottom: 8px;
}

.validation-warning-header::before {
  content: "\26A0\FE0F";  /* Warning emoji */
}

.validation-warning-errors {
  background: #fffbeb;  /* Amber-50 */
  border: 1px solid #fcd34d;  /* Amber-300 */
  border-radius: 4px;
  padding: 8px 12px;
  font-family: 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-word;
  color: #78350f;  /* Amber-900 */
  max-height: 200px;
  overflow-y: auto;
}

/* Validation unavailable note - different style, less alarming */
.validation-unavailable {
  background: #f3f4f6;  /* Gray-100 */
  border: 1px solid #d1d5db;  /* Gray-300 */
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 8px;
  font-size: 13px;
  color: #4b5563;  /* Gray-600 */
  font-style: italic;
}

.validation-unavailable::before {
  content: "\2139\FE0F  ";  /* Info emoji */
}
```

The warning style:
- Amber color scheme signals caution without being as severe as red
- Clear header text explaining the situation
- Monospace errors block for compiler output readability
- Not dismissible (no close button) per CONTEXT.md decisions
- Scrollable errors area for long compiler output
  </action>
  <verify>
```bash
# Check CSS file has new classes
grep -c "validation-warning" /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion/src/bbj_rag/static/chat.css
# Should return 4+ (multiple rules reference this class)
```
  </verify>
  <done>
chat.css includes validation-warning styles: amber banner, monospace error output, non-dismissible design.
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle validation_warning events in JavaScript</name>
  <files>
    rag-ingestion/src/bbj_rag/static/chat.js
  </files>
  <action>
Modify chat.js to handle validation_warning SSE events:

1. **Track validation warnings during streaming:**
   Add to state section:
   ```javascript
   /** @type {Array<{code_index: number, errors: string, code_preview: string}>} */
   let pendingValidationWarnings = [];
   ```

2. **Add case to handleEvent():**
   ```javascript
   case 'validation_warning': {
     // Store warning for injection after markdown render
     pendingValidationWarnings.push(data);
     break;
   }
   ```

3. **Inject warnings after final render:**
   In the 'done' event handler, after `renderMarkdown(accumulated, responseEl)`:
   ```javascript
   // Inject validation warnings above relevant code blocks
   if (pendingValidationWarnings.length > 0) {
     injectValidationWarnings(responseEl, pendingValidationWarnings);
     pendingValidationWarnings = [];
   }
   ```

4. **Create injectValidationWarnings() function:**
   ```javascript
   /**
    * Inject validation warning banners above code blocks that failed validation.
    * @param {HTMLElement} containerEl - The response element containing code blocks
    * @param {Array<{code_index: number, errors: string, code_preview?: string}>} warnings
    */
   function injectValidationWarnings(containerEl, warnings) {
     const codeBlocks = containerEl.querySelectorAll('pre');

     for (const warning of warnings) {
       // code_index is 1-based from backend
       const blockIndex = warning.code_index - 1;
       if (blockIndex < 0 || blockIndex >= codeBlocks.length) continue;

       const targetBlock = codeBlocks[blockIndex];

       // Check if this is a "unavailable" warning (no errors, special message)
       const isUnavailable = !warning.errors ||
         warning.errors.includes('unavailable') ||
         warning.errors.includes('timed out');

       const warningEl = document.createElement('div');

       if (isUnavailable) {
         warningEl.className = 'validation-unavailable';
         warningEl.textContent = warning.errors || 'Syntax validation unavailable';
       } else {
         warningEl.className = 'validation-warning';

         const header = document.createElement('div');
         header.className = 'validation-warning-header';
         header.textContent = 'Could not verify syntax - use with caution';
         warningEl.appendChild(header);

         const errorsEl = document.createElement('div');
         errorsEl.className = 'validation-warning-errors';
         errorsEl.textContent = warning.errors;
         warningEl.appendChild(errorsEl);
       }

       // Insert warning immediately before the code block
       targetBlock.parentNode.insertBefore(warningEl, targetBlock);
     }
   }
   ```

5. **Reset warnings state on new chat:**
   In newChatBtn click handler, add:
   ```javascript
   pendingValidationWarnings = [];
   ```

6. **Handle abort case:**
   In the abort/error catch block, also inject any pending warnings:
   ```javascript
   if (pendingValidationWarnings.length > 0) {
     injectValidationWarnings(responseEl, pendingValidationWarnings);
     pendingValidationWarnings = [];
   }
   ```

Key behavior:
- Warnings stored during streaming
- Injected after final markdown render (so we can find the rendered pre elements)
- Each warning targets a specific code block by index
- Unavailable/timeout gets softer styling than validation failure
- Warnings persist (no dismiss button)
  </action>
  <verify>
```bash
# Check JS file has validation handling
grep -c "validation_warning" /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion/src/bbj_rag/static/chat.js
# Should return 3+ (state var, event case, inject function reference)

grep -c "injectValidationWarnings" /Users/beff/_workspace/bbj-ai-strategy/rag-ingestion/src/bbj_rag/static/chat.js
# Should return 3+ (definition and call sites)
```
  </verify>
  <done>
chat.js handles validation_warning SSE events. Warnings are collected during streaming and injected as banner elements above the relevant code blocks after render completes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete compiler validation flow:
1. Backend validates BBj code blocks via bbjcpl
2. Invalid code triggers automatic fix attempts (up to 3)
3. Persistent failures emit validation_warning SSE events
4. Frontend displays amber warning banners above failed code blocks
5. Valid code displays cleanly with no indicator
  </what-built>
  <how-to-verify>
1. Open http://localhost:10800/chat in your browser
2. Ask a question that will generate BBj code, such as:
   - "Show me how to create a BBj window with a button"
   - "Write BBj code to read a file line by line"

3. Observe the response:
   - Code should appear in syntax-highlighted blocks
   - If code validated successfully: NO warning banner (silent success)
   - If code failed validation: Amber warning banner above the block with compiler errors

4. Test edge cases:
   - Ask for Python code ("How do I read a file in Python?") - should have no validation warnings (not BBj)
   - If bbjcpl is not available on your system, you should see a softer "Syntax validation unavailable" note

5. Verify warning styling:
   - Warning has amber background
   - Compiler errors shown in monospace
   - No dismiss/close button (warning persists)
  </how-to-verify>
  <resume-signal>Type "approved" if validation warnings display correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. CSS includes validation-warning styles
2. JS handles validation_warning events
3. Warnings inject before correct code blocks
4. Valid code has no visual indicator
5. Failed validation shows amber warning with compiler errors
6. Unavailable validation shows softer note

Visual verification required - see checkpoint task.
</verification>

<success_criteria>
- Warning banners appear above code blocks that failed validation
- Warnings include full bbjcpl stderr output
- Valid code displays with no indicator (clean output)
- Unavailable validation shows informative note
- Warnings are not dismissible
- Human verification confirms correct display
</success_criteria>

<output>
After completion, create `.planning/phases/28-compiler-validation/28-03-SUMMARY.md`
</output>
