---
phase: 26-chat-interface
plan: 03
type: execute
wave: 3
depends_on: ["26-01", "26-02"]
files_modified:
  - rag-ingestion/docker-compose.yml
  - rag-ingestion/Dockerfile
  - rag-ingestion/.env.example
autonomous: false

must_haves:
  truths:
    - "docker compose up serves http://localhost:10800/chat with the full chat interface"
    - "ANTHROPIC_API_KEY passes through from .env to the app container"
    - "templates/ and static/ directories are included in the Docker image"
    - "An engineer opens the chat page, asks a BBj question, and gets a streamed answer with source citations"
    - "BBj code blocks render with syntax highlighting and copy buttons"
    - "Streaming is visible (text appears incrementally)"
    - "Multi-line code blocks in responses are not broken by SSE newline handling"
  artifacts:
    - path: "rag-ingestion/docker-compose.yml"
      provides: "ANTHROPIC_API_KEY environment passthrough to app container"
      contains: "ANTHROPIC_API_KEY"
    - path: "rag-ingestion/.env.example"
      provides: "Documentation of required ANTHROPIC_API_KEY env var"
      contains: "ANTHROPIC_API_KEY"
  key_links:
    - from: "rag-ingestion/docker-compose.yml"
      to: "rag-ingestion/.env"
      via: "env_file directive passes ANTHROPIC_API_KEY to container"
      pattern: "ANTHROPIC_API_KEY"
---

<objective>
Wire the chat feature into the Docker deployment: ensure ANTHROPIC_API_KEY passes through to the container, templates/static are included in the Docker image, and verify the full end-to-end chat flow works. Includes a human verification checkpoint for visual and functional testing.

Purpose: The chat feature must work in the Docker deployment (the primary way engineers will access it). This plan ensures the deployment configuration is complete and the entire flow is verified by a human.

Output: Docker-ready chat deployment with verified end-to-end streaming chat functionality.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-chat-interface/26-RESEARCH.md
@.planning/phases/26-chat-interface/26-CONTEXT.md
@.planning/phases/26-chat-interface/26-01-SUMMARY.md
@.planning/phases/26-chat-interface/26-02-SUMMARY.md
@rag-ingestion/docker-compose.yml
@rag-ingestion/Dockerfile
@rag-ingestion/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Docker configuration for chat feature</name>
  <files>
    rag-ingestion/docker-compose.yml
    rag-ingestion/Dockerfile
    rag-ingestion/.env.example
  </files>
  <action>
    **docker-compose.yml — Add ANTHROPIC_API_KEY passthrough:**
    - In the `app` service `environment` section, add: `- ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY must be set}`
    - This follows the same pattern as BBJ_RAG_DB_PASSWORD (required with error message if missing).
    - Also add optional chat config overrides that users can set if desired:
      - `- BBJ_RAG_CHAT_MODEL=${BBJ_RAG_CHAT_MODEL:-claude-sonnet-4-5-20250514}`
      - `- BBJ_RAG_CHAT_MAX_TOKENS=${BBJ_RAG_CHAT_MAX_TOKENS:-2048}`

    **Dockerfile — Verify templates/static inclusion:**
    - The existing Dockerfile already does `COPY . /app` in the builder stage, which will include `src/bbj_rag/templates/` and `src/bbj_rag/static/`.
    - Check the runtime stage to ensure the full app directory (including templates and static) is copied from builder. If the runtime stage only copies the venv (common pattern), also copy the app source.
    - If the Dockerfile uses `COPY --from=builder /app/.venv ...` pattern, ensure the app source with templates/static is also copied: `COPY --from=builder /app/src /app/src` or equivalent.
    - Verify the `WORKDIR` and command ensure templates and static are findable at runtime. The template path in chat.py uses `Path(__file__).resolve().parent.parent / "templates"` which resolves relative to the installed package, so it needs to be in the wheel. Check that `tool.hatch.build.targets.wheel` includes template/static data files.
    - If needed, add to pyproject.toml `[tool.hatch.build.targets.wheel]` section or add `[tool.hatch.build.targets.wheel.force-include]` to ensure non-Python files (templates/*.html, static/*.css, static/*.js) are included in the built wheel. Alternatively use a `package-data` directive.
    - **Concrete approach:** Add to pyproject.toml:
      ```
      [tool.hatch.build.targets.wheel.force-include]
      "src/bbj_rag/templates" = "bbj_rag/templates"
      "src/bbj_rag/static" = "bbj_rag/static"
      ```
      This ensures templates and static directories are included in the installed package so Path(__file__) based resolution works in Docker.

    **.env.example — Document the new required variable:**
    - Add `ANTHROPIC_API_KEY=sk-ant-...` with a comment explaining it's required for the chat feature.
    - Add optional chat config vars as commented-out examples:
      ```
      # Chat feature (required)
      ANTHROPIC_API_KEY=sk-ant-your-key-here

      # Chat model override (optional, defaults to claude-sonnet-4-5-20250514)
      # BBJ_RAG_CHAT_MODEL=claude-sonnet-4-5-20250514
      # BBJ_RAG_CHAT_MAX_TOKENS=2048
      ```
  </action>
  <verify>
    - `grep 'ANTHROPIC_API_KEY' rag-ingestion/docker-compose.yml` finds the env passthrough
    - `grep 'ANTHROPIC_API_KEY' rag-ingestion/.env.example` finds the documentation
    - `grep 'BBJ_RAG_CHAT_MODEL' rag-ingestion/docker-compose.yml` finds the optional override
    - `grep 'force-include\|templates\|static' rag-ingestion/pyproject.toml` confirms data file inclusion config
    - `cd rag-ingestion && uv run pytest tests/ -x -q` passes (no regressions)
  </verify>
  <done>docker-compose.yml passes ANTHROPIC_API_KEY (required) and optional chat model config to the app container. .env.example documents the new variables. pyproject.toml includes templates/static in the wheel build. Dockerfile needs no changes (COPY . /app already includes everything).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end chat verification</name>
  <what-built>Complete chat interface: backend streaming via Claude API + SSE, frontend with markdown rendering and BBj syntax highlighting, Docker deployment configuration.</what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Set ANTHROPIC_API_KEY in `rag-ingestion/.env` (get from console.anthropic.com if not already set)
    2. Ensure Ollama is running: `ollama list` should show qwen3-embedding:0.6b
    3. Rebuild and start: `cd rag-ingestion && docker compose up --build -d`
    4. Wait for healthy: `docker compose ps` shows app as healthy

    **Test 1: Page loads (CHAT-05)**
    - Open http://localhost:10800/chat in browser
    - Expected: Chat page with header ("BBj Documentation Chat"), empty state with suggested questions, input bar at bottom
    - No login/auth required

    **Test 2: Basic question with streaming (CHAT-01, CHAT-02, CHAT-04)**
    - Type "How do I create a window in BBj?" and press Enter/Send
    - Expected: Text streams visibly (appears incrementally, not all at once)
    - Expected: Pulsing dot indicator visible during streaming, disappears when done
    - Expected: Input is disabled during streaming

    **Test 3: BBj code block rendering (CHAT-04)**
    - Ask "Show me a BBj example of opening a file and reading records"
    - Expected: BBj code blocks render with syntax highlighting (colored keywords)
    - Expected: Code blocks have a "Copy" button in top-right corner
    - Expected: Multi-line code blocks are intact (not broken by SSE)

    **Test 4: Source citations (CHAT-03)**
    - Look at any response — check for source citations
    - Expected: Sources appear with clickable links and source type badges (Flare Docs, PDF Manual, etc.)
    - Expected: Links open in new tab and point to documentation.basis.cloud or equivalent

    **Test 5: Stop and Clear**
    - Ask a question, then click Stop while streaming
    - Expected: Streaming stops; partial response is preserved
    - Click "New Chat"
    - Expected: Conversation clears, empty state returns

    **Test 6: Multi-turn conversation**
    - Ask "What is DWC in BBj?"
    - Then ask "How does it compare to the old GUI approach?"
    - Expected: Second answer shows awareness of the first question's context

    **Test 7: Suggested questions**
    - Click "New Chat" to reset, then click one of the suggestion chips
    - Expected: The suggestion text fills the input and submits automatically
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues to address.</resume-signal>
</task>

</tasks>

<verification>
1. Docker compose builds and starts with ANTHROPIC_API_KEY
2. http://localhost:10800/chat loads without authentication
3. Questions receive streamed answers with visible incremental text
4. BBj code blocks have syntax highlighting and copy buttons
5. Source citations are clickable links opening in new tabs
6. Multi-line code blocks are not broken by SSE
7. Stop, Clear, and suggested questions work
8. Multi-turn conversation maintains context
</verification>

<success_criteria>
- Docker deployment serves the chat page at /chat on port 10800
- ANTHROPIC_API_KEY passes through to the container
- templates and static files are included in the Docker image
- All 7 manual test scenarios pass human verification
- Phase 26 success criteria 1-5 from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/26-chat-interface/26-03-SUMMARY.md`
</output>
