---
phase: 24-end-to-end-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/docker-compose.yml
  - rag-ingestion/sources.toml
  - rag-ingestion/VALIDATION.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PDF source (GuideToGuiProgrammingInBBj.pdf) has chunks in the database after re-ingestion"
    - "curl localhost:10800/stats shows non-zero chunk count for pdf doc_type or pdf-prefixed source"
    - "All 6 logical sources now have chunks in the database"
    - "Re-running validation script shows improved pass count (PDF no longer missing from cross-source table)"
  artifacts:
    - path: "rag-ingestion/docker-compose.yml"
      provides: "PDF file volume mount into /app/ for container access"
      contains: "GuideToGuiProgrammingInBBj.pdf"
    - path: "rag-ingestion/sources.toml"
      provides: "Corrected PDF path resolved inside container"
      contains: "/app/GuideToGuiProgrammingInBBj.pdf"
    - path: "rag-ingestion/VALIDATION.md"
      provides: "Updated validation report with PDF source present"
  key_links:
    - from: "rag-ingestion/sources.toml"
      to: "rag-ingestion/docker-compose.yml"
      via: "PDF path in sources.toml must match the volume mount destination"
      pattern: "/app/GuideToGuiProgrammingInBBj.pdf"
---

<objective>
Fix the PDF source ingestion gap: the GuideToGuiProgrammingInBBj.pdf file is not accessible inside the Docker container because it lacks a volume mount and sources.toml uses a relative path that does not resolve to the container filesystem. After fixing, re-ingest the PDF source and re-run the validation to confirm all 6 sources are present.

Purpose: Close the one verification gap (4/5 -> 5/5 truths) so the v1.4 milestone is fully validated with all 6 BBj documentation sources ingested.
Output: Updated docker-compose.yml, sources.toml, re-ingested PDF chunks in database, and refreshed VALIDATION.md report.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-end-to-end-validation/24-01-SUMMARY.md
@.planning/phases/24-end-to-end-validation/24-VERIFICATION.md
@rag-ingestion/docker-compose.yml
@rag-ingestion/sources.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PDF volume mount and source path</name>
  <files>rag-ingestion/docker-compose.yml, rag-ingestion/sources.toml</files>
  <action>
Two changes are needed to make the PDF file accessible inside the Docker container:

1. **docker-compose.yml** -- Add a volume mount for the PDF file to the `app` service's `volumes` list. Add this line after the existing source data volume mounts:
   ```
   - ./GuideToGuiProgrammingInBBj.pdf:/app/GuideToGuiProgrammingInBBj.pdf:ro
   ```
   This mounts the PDF from the project root (one level up from rag-ingestion/) into the container at /app/. IMPORTANT: The docker-compose.yml lives in `rag-ingestion/`, so the relative path `./GuideToGuiProgrammingInBBj.pdf` resolves to `rag-ingestion/GuideToGuiProgrammingInBBj.pdf` which does NOT exist. The PDF is at the repo root. Use `../GuideToGuiProgrammingInBBj.pdf` instead:
   ```
   - ../GuideToGuiProgrammingInBBj.pdf:/app/GuideToGuiProgrammingInBBj.pdf:ro
   ```

2. **sources.toml** -- Change the PDF source `paths` from the current relative path to an absolute container path:
   ```toml
   paths = ["/app/GuideToGuiProgrammingInBBj.pdf"]
   ```
   This bypasses the DATA_DIR resolution entirely since the path is absolute, pointing directly to where the volume mount places the file.

After editing both files, restart the app container to pick up the new volume mount:
```bash
cd rag-ingestion && docker compose up -d app
```

Then run PDF-only ingestion with --clean to start fresh for this source:
```bash
docker exec -it rag-ingestion-app-1 uv run bbj-ingest-all --source pdf --clean
```

Verify ingestion produced chunks (expect ~40-80 chunks based on 1.4MB PDF):
```bash
curl -s http://localhost:10800/stats | python3 -m json.tool
```
Look for pdf-related entries in the by_source breakdown. Also verify directly:
```bash
docker exec rag-ingestion-db-1 psql -U bbj -d bbj_rag -c "SELECT COUNT(*) FROM chunks WHERE source_url LIKE 'pdf://%';"
```
The count must be > 0.
  </action>
  <verify>
1. `docker exec rag-ingestion-db-1 psql -U bbj -d bbj_rag -c "SELECT COUNT(*) FROM chunks WHERE source_url LIKE 'pdf://%';"` returns a count > 0
2. `curl -s http://localhost:10800/stats` shows total_chunks increased from 50,392
3. `docker exec rag-ingestion-app-1 ls /app/GuideToGuiProgrammingInBBj.pdf` succeeds (file exists in container)
  </verify>
  <done>PDF source has non-zero chunks in the database. The volume mount correctly exposes the host file inside the container, and sources.toml points to the correct container path.</done>
</task>

<task type="auto">
  <name>Task 2: Re-run validation and update report</name>
  <files>rag-ingestion/VALIDATION.md</files>
  <action>
Re-run the existing validation script to regenerate VALIDATION.md with updated results that include the PDF source:

```bash
cd rag-ingestion && uv run python scripts/validate_e2e.py
```

This will:
- Re-query all 14 REST API queries (6 source-targeted + 7 topic-based + 1 generation-filtered)
- Re-query all 3 MCP queries
- Regenerate the cross-source summary table
- Overwrite VALIDATION.md with fresh results

After the script completes, check the output:
1. The cross-source summary table should now show "Yes" for the PDF row (previously "No")
2. The source-targeted query for PDF ("customer information program BBj GUI example") may now pass if pdf:// chunks rank in top results
3. The overall pass count should be >= 13/17 (may improve if PDF chunks help targeted queries)
4. The corpus stats section should show a higher total_chunks count

If the validation script fails for any reason (Docker not running, Ollama down), check prerequisites:
- `docker compose ps` -- both containers healthy
- `curl http://localhost:10800/health` -- returns {"status":"healthy"}
- Ollama running on host with `OLLAMA_HOST=0.0.0.0:11434`
  </action>
  <verify>
1. `rag-ingestion/VALIDATION.md` exists and contains a "Generated:" timestamp newer than the previous report
2. The Cross-Source Summary table shows PDF row with "Yes" in the "Found in Results" column, OR the corpus stats show pdf-related chunks (confirming PDF is in the database even if it doesn't rank in top-5 for queries)
3. The corpus stats total_chunks is greater than 50,392
  </verify>
  <done>VALIDATION.md regenerated with PDF source included in the corpus. The cross-source summary reflects all 6 sources having chunks in the database.</done>
</task>

</tasks>

<verification>
1. `docker exec rag-ingestion-db-1 psql -U bbj -d bbj_rag -c "SELECT COUNT(*) FROM chunks WHERE source_url LIKE 'pdf://%';"` returns count > 0
2. `curl -s http://localhost:10800/stats` shows increased total_chunks with pdf entries
3. `rag-ingestion/VALIDATION.md` has been regenerated with updated timestamp
4. The verification gap (truth #4: "All 6 logical sources have chunks in the database") is now closable
</verification>

<success_criteria>
- PDF source has chunks in the database (was 0, now > 0)
- docker-compose.yml has the PDF volume mount
- sources.toml points to the correct container-internal path
- VALIDATION.md regenerated with all 6 sources represented in corpus stats
- Total chunk count > 50,392 (previous count before PDF)
</success_criteria>

<output>
After completion, create `.planning/phases/24-end-to-end-validation/24-02-SUMMARY.md`
</output>
