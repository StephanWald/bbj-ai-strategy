---
phase: 10-flare-parser
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - rag-ingestion/pyproject.toml
  - rag-ingestion/src/bbj_rag/parsers/__init__.py
  - rag-ingestion/src/bbj_rag/parsers/flare_toc.py
  - rag-ingestion/src/bbj_rag/parsers/flare_cond.py
  - rag-ingestion/tests/test_flare_toc.py
  - rag-ingestion/tests/test_flare_cond.py
autonomous: true

must_haves:
  truths:
    - "TOC index maps Content-relative paths to arrow-separated breadcrumb strings for all 4 .fltoc files"
    - "TOC priority is basishelp > emhelp > bdthelp > pro5toc (first-found wins for duplicate topics)"
    - "Orphan topics (not in any TOC) get directory-based fallback paths"
    - "[%=System.LinkedTitle%] TOC entries are resolved from the topic file's <title> tag"
    - "Condition tag set parser reads Primary.flcts and identifies 6 generation-relevant tags vs 6 cosmetic tags"
    - "Condition extraction from <html> root MadCap:conditions attribute produces flat list of condition strings"
    - "DocumentParser protocol defines parse() -> Iterator[Document] contract for all parsers"
  artifacts:
    - path: "rag-ingestion/src/bbj_rag/parsers/__init__.py"
      provides: "DocumentParser Protocol and MADCAP_NS constant"
      exports: ["DocumentParser", "MADCAP_NS"]
    - path: "rag-ingestion/src/bbj_rag/parsers/flare_toc.py"
      provides: "TOC index builder from .fltoc files"
      exports: ["build_toc_index", "directory_fallback_path"]
    - path: "rag-ingestion/src/bbj_rag/parsers/flare_cond.py"
      provides: "Condition tag set parser and per-topic condition extractor"
      exports: ["parse_condition_tag_set", "extract_topic_conditions", "map_conditions_to_generations"]
    - path: "rag-ingestion/tests/test_flare_toc.py"
      provides: "Tests for TOC index builder"
    - path: "rag-ingestion/tests/test_flare_cond.py"
      provides: "Tests for condition tag extraction"
  key_links:
    - from: "rag-ingestion/src/bbj_rag/parsers/flare_toc.py"
      to: "lxml.etree"
      via: "XML parsing of .fltoc files"
      pattern: "etree\\.parse"
    - from: "rag-ingestion/src/bbj_rag/parsers/flare_cond.py"
      to: "lxml.etree"
      via: "XML parsing of .flcts and XHTML condition attributes"
      pattern: "etree\\.parse|etree\\.QName"
    - from: "rag-ingestion/src/bbj_rag/parsers/__init__.py"
      to: "rag-ingestion/src/bbj_rag/models.py"
      via: "Document type in Protocol return type"
      pattern: "from bbj_rag\\.models import Document"
---

<objective>
Create the parser foundation for Phase 10: add lxml/httpx/bs4 dependencies, define the DocumentParser protocol, build the TOC index from .fltoc files, and implement the condition tag extractor. These are the shared building blocks that the Flare XHTML parser (Plan 02) and web crawl parser (Plan 03) depend on.

Purpose: All parsers need the protocol contract, and the Flare parser specifically needs the TOC index (for hierarchy paths) and condition extractor (for generation metadata). Building and testing these independently ensures the foundations are solid before tackling the complex XHTML parser.

Output: parsers package with protocol, TOC index builder, condition tag extractor, and comprehensive tests against real Flare project files.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-flare-parser/10-RESEARCH.md
@rag-ingestion/src/bbj_rag/models.py
@rag-ingestion/src/bbj_rag/config.py
@rag-ingestion/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create parsers package with protocol, TOC index, and condition extractor</name>
  <files>
    rag-ingestion/pyproject.toml
    rag-ingestion/src/bbj_rag/parsers/__init__.py
    rag-ingestion/src/bbj_rag/parsers/flare_toc.py
    rag-ingestion/src/bbj_rag/parsers/flare_cond.py
  </files>
  <action>
    **Step 1: Add dependencies via uv.**
    Run from `rag-ingestion/`:
    ```bash
    uv add "lxml>=5.3,<6" "httpx>=0.28,<1" "beautifulsoup4>=4.13,<5"
    ```
    Also add lxml type stubs for mypy strict mode:
    ```bash
    uv add --group dev "lxml-stubs>=0.5"
    ```

    **Step 2: Create `parsers/__init__.py`.**
    Define:
    - `MADCAP_NS = "http://www.madcapsoftware.com/Schemas/MadCap.xsd"` constant
    - `DocumentParser` Protocol with `def parse(self) -> Iterator[Document]` method
    - Import Document from bbj_rag.models
    - `__all__` list with public exports

    **Step 3: Create `flare_toc.py` -- TOC index builder.**
    Implement:
    - `build_toc_index(toc_dir: Path, content_dir: Path | None = None) -> dict[str, str]`
      - Parse all 4 .fltoc files in priority order: basishelp > emhelp > bdthelp > pro5toc
      - Use `lxml.etree.parse()` for XML parsing
      - Walk `<TocEntry>` elements recursively, building breadcrumb from nested Title attributes
      - Handle `Link` attribute: strip leading `/Content/` prefix to get Content-relative path
      - First-found wins (priority order prevents overwriting)
      - Handle `[%=System.LinkedTitle%]` entries: when Title is this pattern, resolve from the linked topic file's `<head><title>` tag using content_dir parameter
      - Handle section-only entries (no Link attribute): use as breadcrumb grouping headers
    - `directory_fallback_path(content_relative_path: str) -> str`
      - For orphan topics not in any TOC, derive hierarchy from directory path
      - Input: `"bbjobjects/Window/bbjwindow/bbjwindow_addbutton.htm"`
      - Output: `"bbjobjects > Window > bbjwindow"` (strip filename, join with " > ")
      - Clean up directory names: replace underscores with spaces where appropriate
    - Private `_walk_toc()` helper for recursive traversal
    - All functions must have full type annotations (mypy strict)

    **Step 4: Create `flare_cond.py` -- condition tag extractor.**
    Implement:
    - `ConditionTag` as a simple dataclass or TypedDict: `name: str, generation_relevant: bool`
    - `GENERATION_RELEVANT_CONDITIONS: dict[str, str]` mapping condition names to their semantic meaning:
      - `"Primary.BASISHelp"` -> `"bbj"` (main BBj docs)
      - `"Primary.BDTHelp"` -> `"bdt"` (Eclipse tools)
      - `"Primary.EMHelp"` -> `"em"` (Enterprise Manager)
      - `"Primary.Deprecated"` -> `"deprecated"` (deprecation flag)
      - `"Primary.Superseded"` -> `"superseded"` (supersession flag)
      - `"Primary.NotImplemented"` -> `"not_implemented"` (not-yet-implemented flag)
    - `parse_condition_tag_set(flcts_path: Path) -> list[ConditionTag]`
      - Parse Primary.flcts XML file
      - Extract all condition tag definitions
    - `extract_topic_conditions(root: etree._Element) -> list[str]`
      - Extract `MadCap:conditions` attribute from the `<html>` root element
      - Split comma-separated values into flat list
      - Return empty list if no conditions present
    - `extract_inline_conditions(body: etree._Element) -> dict[str, list[str]]`
      - Walk body elements looking for `MadCap:conditions` attributes on inline elements
      - Return mapping of element XPath/identifier to condition list
      - Used by Phase 11 for chunk-level tagging
    - `map_conditions_to_generations(conditions: list[str]) -> list[str]`
      - Map condition strings to generation labels using GENERATION_RELEVANT_CONDITIONS
      - Default to `["bbj"]` if no conditions or no generation-relevant conditions found
      - Filter out non-generation conditions (cosmetic ones like Navigation, *_chm)
    - All functions must have full type annotations (mypy strict)
  </action>
  <verify>
    Run from `rag-ingestion/`:
    ```bash
    uv run python -c "from lxml import etree; print('lxml OK')"
    uv run python -c "import httpx; print('httpx OK')"
    uv run python -c "import bs4; print('bs4 OK')"
    uv run python -c "from bbj_rag.parsers import DocumentParser, MADCAP_NS; print('parsers OK')"
    uv run python -c "from bbj_rag.parsers.flare_toc import build_toc_index; print('toc OK')"
    uv run python -c "from bbj_rag.parsers.flare_cond import extract_topic_conditions, map_conditions_to_generations; print('cond OK')"
    uv run mypy src/bbj_rag/parsers/
    uv run ruff check src/bbj_rag/parsers/
    ```
  </verify>
  <done>
    - lxml, httpx, bs4 importable; pyproject.toml updated with new deps
    - parsers package exists with DocumentParser protocol and MADCAP_NS constant
    - flare_toc.py exports build_toc_index and directory_fallback_path
    - flare_cond.py exports condition extraction and generation mapping functions
    - mypy strict and ruff pass on all new files
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for TOC index and condition tag extraction using real Flare project files</name>
  <files>
    rag-ingestion/tests/test_flare_toc.py
    rag-ingestion/tests/test_flare_cond.py
  </files>
  <action>
    **Write tests that run against the actual Flare project at `/Users/beff/bbjdocs/`.**

    Use `pytest.mark.skipif(not Path("/Users/beff/bbjdocs").exists(), reason="Flare source not available")` to skip gracefully on CI or other machines.

    **test_flare_toc.py:**
    - `test_build_toc_index_returns_dict`: Build index from real TOC files at `/Users/beff/bbjdocs/Project/TOCs/`, verify returns dict[str, str] with >1000 entries
    - `test_toc_priority_basishelp_wins`: Verify a topic appearing in both basishelp and pro5toc gets the basishelp breadcrumb (140 topics overlap)
    - `test_toc_entry_has_arrow_separator`: Pick a known topic path and verify breadcrumb uses " > " separator
    - `test_section_only_entries_no_link`: Verify entries without Link attributes don't produce index entries but contribute to breadcrumbs
    - `test_linked_title_resolution`: Verify `[%=System.LinkedTitle%]` entries get resolved from topic `<title>` tag (requires content_dir parameter)
    - `test_directory_fallback_path`: Test directory_fallback_path with sample paths:
      - `"bbjobjects/Window/bbjwindow/bbjwindow_addbutton.htm"` -> `"bbjobjects > Window > bbjwindow"`
    - `test_orphan_topic_count`: Build index, count topics in Content/ not in index -- verify roughly 5,500 orphans (78% of ~7,083)
    - Also add unit tests with synthetic XML strings (no file dependency) for core logic

    **test_flare_cond.py:**
    - `test_parse_condition_tag_set`: Parse real `/Users/beff/bbjdocs/Project/ConditionTagSets/Primary.flcts`, verify 12 tags found
    - `test_extract_topic_conditions_with_real_file`: Parse a known topic with BASISHelp condition, verify extraction
    - `test_extract_topic_conditions_empty`: Parse a topic with no MadCap:conditions, verify empty list
    - `test_map_conditions_to_generations_basishelp`: `["Primary.BASISHelp"]` -> `["bbj"]`
    - `test_map_conditions_to_generations_deprecated`: `["Primary.BASISHelp", "Primary.Deprecated"]` -> `["bbj", "deprecated"]`
    - `test_map_conditions_to_generations_no_conditions`: `[]` -> `["bbj"]` (default)
    - `test_map_conditions_cosmetic_only`: `["Primary.Navigation"]` -> `["bbj"]` (default when no generation-relevant conditions)
    - Unit tests with synthetic XML for condition extraction logic

    **Run and verify:**
    ```bash
    cd rag-ingestion && uv run pytest tests/test_flare_toc.py tests/test_flare_cond.py -v
    ```

    If any test fails, fix the implementation in flare_toc.py or flare_cond.py (TDD green phase). Then run mypy and ruff on both source and test files.
  </action>
  <verify>
    ```bash
    cd rag-ingestion
    uv run pytest tests/test_flare_toc.py tests/test_flare_cond.py -v
    uv run mypy src/bbj_rag/parsers/ tests/test_flare_toc.py tests/test_flare_cond.py
    uv run ruff check src/bbj_rag/parsers/ tests/
    ```
    All tests pass, mypy strict passes, ruff passes.
  </verify>
  <done>
    - All TOC index tests pass including real-file tests against /Users/beff/bbjdocs/
    - All condition tag tests pass including real-file tests
    - TOC index correctly builds from all 4 .fltoc files with priority ordering
    - Condition extraction correctly identifies generation-relevant vs cosmetic tags
    - map_conditions_to_generations produces correct generation labels
    - mypy strict and ruff pass on all files
  </done>
</task>

</tasks>

<verification>
Run the full verification suite from `rag-ingestion/`:
```bash
uv run pytest tests/test_flare_toc.py tests/test_flare_cond.py -v
uv run mypy src/bbj_rag/parsers/
uv run ruff check src/ tests/
```

All must pass. The TOC index should map 1,500+ topics. Condition extraction should identify 6 generation-relevant tags.
</verification>

<success_criteria>
1. lxml, httpx, beautifulsoup4 installed and importable
2. DocumentParser protocol defined with parse() -> Iterator[Document]
3. build_toc_index() produces a dict with 1,500+ entries from real .fltoc files
4. directory_fallback_path() derives arrow-separated hierarchy from file paths
5. Condition tag extraction produces correct generation labels from real topic files
6. All tests pass, mypy strict passes, ruff passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-flare-parser/10-01-SUMMARY.md`
</output>
