---
phase: 23.1-wordpress-parser-fix
plan: 01
subsystem: parsers
tags: [wordpress, pdf, httpx, content-type, pymupdf, beautifulsoup]

# Dependency graph
requires:
  - phase: 17-wordpress-parsers
    provides: "AdvantageParser and KnowledgeBaseParser base implementation"
provides:
  - "WordPress parser with PDF handling via URL extension and Content-Type header"
  - "Content-Type fallback detection for redirected PDF URLs"
  - "Relative URL resolution on index page via urljoin"
  - "Batch embedding verified as already functional (no changes needed)"
affects: [24-search-seo-launch, ingestion-pipeline]

# Tech tracking
tech-stack:
  added: [pymupdf, pymupdf4llm]
  patterns:
    - "_fetch_response() returns raw httpx.Response for header-based routing"
    - "Content-Type substring check for MIME type detection with params"

key-files:
  created: []
  modified:
    - "rag-ingestion/src/bbj_rag/parsers/wordpress.py"
    - "rag-ingestion/tests/test_wordpress_parser.py"

key-decisions:
  - "Keep _fetch_page() for backward compat; new _fetch_response() for header inspection"
  - "Substring check ('application/pdf' in ct.lower()) handles Content-Type params"
  - "Batch embedding already implemented -- no code changes needed (verified)"

patterns-established:
  - "_fetch_response() pattern: return raw Response when callers need header inspection"
  - "Content-Type-based format routing in parse() loop"

# Metrics
duration: 4min
completed: 2026-02-02
---

# Phase 23.1 Plan 01: WordPress Parser Fix Summary

**PDF handling via URL extension + Content-Type header fallback with _fetch_response() helper, batch embedding verified as already functional**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-02T12:00:51Z
- **Completed:** 2026-02-02T12:04:56Z
- **Tasks:** 3 (2 code tasks + 1 verification-only)
- **Files modified:** 2

## Accomplishments
- WordPress parser correctly handles PDFs linked from Advantage index page via `.pdf` extension detection
- Added Content-Type-based fallback detection for redirected URLs that serve PDFs without `.pdf` extension
- Relative hrefs on index page resolved to absolute URLs via `urljoin()`
- Batch embedding verified end-to-end: pipeline.py batches chunks (batch_size=64) -> embedder.embed_batch() -> ollama.embed(input=texts). No code changes required.
- All 32 tests pass, `make check` green (lint + typecheck + 329 tests)

## Task Commits

Each task was committed atomically:

1. **Task 1a: PDF handling + relative URL resolution** - `73edf42` (feat) -- existing working tree fix
2. **Task 1b: Content-Type PDF detection** - `cdb20da` (feat) -- _fetch_response() + Content-Type routing
3. **Task 2: Content-Type detection tests** - `207cca8` (test) -- 3 new tests for Content-Type handling
4. **Task 3: Batch embedding verification** - no commit (read-only verification, no code changes)

## Files Created/Modified
- `rag-ingestion/src/bbj_rag/parsers/wordpress.py` - Added _is_pdf_url(), _fetch_pdf_bytes(), _fetch_response(), _title_from_pdf_url(), _parse_pdf_bytes(); Content-Type header check in parse() loop; urljoin for relative URLs
- `rag-ingestion/tests/test_wordpress_parser.py` - Added TestIsPdfUrl, TestTitleFromPdfUrl, TestRelativeUrlResolution, TestParsePdfBytes, TestMixedContent, TestContentTypePdfDetection classes; updated _mock_get() for bytes/headers support

## Decisions Made
- **Keep _fetch_page() alongside _fetch_response():** KnowledgeBaseParser still uses _fetch_page() which returns str. New _fetch_response() returns raw httpx.Response for header inspection in AdvantageParser.
- **Substring Content-Type check:** `"application/pdf" in ct.lower()` handles params like `; charset=utf-8` without regex.
- **Batch embedding: no changes needed:** pipeline.py already batches at 64 chunks and calls embed_batch() which passes a list to ollama.embed(input=texts) in a single API call.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- WordPress parser handles both extension-based and Content-Type-based PDF detection
- All existing tests pass alongside new tests
- Ready for remaining Phase 23.1 plans (02: README, 03: re-ingestion) or Phase 24

---
*Phase: 23.1-wordpress-parser-fix*
*Completed: 2026-02-02*
